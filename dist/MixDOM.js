var e,t,n;(e=>{e[e.Data=1]='Data',e[e.Actions=2]='Actions',e[e.Otherwise=4]='Otherwise',e[e.DoRefresh=8]='DoRefresh',e[e.None=0]='None',e[e.Contextual=3]='Contextual',e[e.All=7]='All'})(e||(e={})),(e=>{e[e.Cascading=1]='Cascading',e[e.Parent=2]='Parent',e[e.Overridden=4]='Overridden',e[e.None=0]='None',e[e.All=7]='All'})(t||(t={})),(e=>{e[e.never=-3]='never',e[e.always=-2]='always',e[e.deep=-1]='deep',e[e.changed=0]='changed',e[e.shallow=1]='shallow',e[e.double=2]='double'})(n||(n={}));const s={COMPLEX_DOM_PROPS:{style:!0,data:!0},range(e,t,n=1){null==t&&([t,e]=[e,0]);const s=[];if(t<e)for(let o=e-1;o>=t;o-=n)s.push(o);else for(let o=e;o<t;o+=n)s.push(o);return s},decapitalize:(e,t='')=>e.replace(/([A-Z])/g,t+'$1').toLowerCase(),buildRecordable(e){if(e.constructor===Object)return e;const t={};for(const n of e)t[n]=!0;return t},refreshWithTimeout(e,t,n,s,o){null!==n&&void 0!==o&&(clearTimeout(n),n=null);const r=void 0===o?s:o;return null===r?t.call(e):null===n&&(n=setTimeout((()=>t.call(e)),r)),n},cleanDOMProps(e,t){const n=t?Object.assign({},e):e;return n.class&&(n.className=n.className?n.class+' '+n.className:n.class),delete n.class,'string'==typeof n.style&&(n.style=s.cleanDOMStyle(n.style)),n},cleanDOMStyle(e){const t=e.replace(/\/\*(.|\s)*?\*\//g,' ').replace(/\s+/g,' ').trim();if(!t)return{};const n={},s=t.split(';').map((e=>e.split(':').map((e=>e&&e.trim()))));for(const[e,t]of s)e&&(n[e.replace(/\W+\w/g,(e=>e.slice(-1).toUpperCase()))]=t);return n},cleanDOMClass(...e){const t={};for(const n of e)n&&s.collectNamesTo(n,t,' ');return Object.keys(t).join(' ')},collectNamesTo(e,t,n=''){switch(typeof e){case'string':if(n)for(const s of e.split(n))s&&(t[s]=!0);else t[e]=!0;break;case'object':if(e.constructor===Object)for(const n in e)n&&e[n]&&(t[n]=!0);else for(const s of e)if(s&&'string'==typeof s)if(n)for(const e of s.split(n))e&&(t[e]=!0);else t[s]=!0}},getClassNameDiffs(e,t){if((e=e||'')===(t=t||''))return null;const n=e.split(' '),s=t.split(' '),o={};let r=null;if(n)for(const e of n)!e||s&&-1!==s.indexOf(e)||(o[e]=r=!1);if(s)for(const e of s)!e||n&&-1!==n.indexOf(e)||(o[e]=r=!0);return null!==r?o:null},getDictionaryDiffs(e,t){const n={};let s=!1;for(const o in e){void 0!==e[o]&&void 0===t[o]&&(n[o]=void 0,s=!0)}for(const o in t){const r=t[o];e[o]!==r&&(n[o]=r,s=!0)}return s?n:null},equalDOMProps(e,t){for(const n in s.COMPLEX_DOM_PROPS)if(e[n]){if(!t[n])return!1;const s=e[n],o=t[n];if(s!==o){for(const e in o)if(s[e]!==o[e])return!1;for(const e in s)if(void 0===o[e]&&void 0!==s[e])return!1}}else if(t[n])return!1;for(const n in t)if(e[n]!==t[n]&&!s.COMPLEX_DOM_PROPS[n])return!1;for(const n in e)if(void 0===t[n]&&void 0!==e[n]&&!s.COMPLEX_DOM_PROPS[n])return!1;return!0},equalDictionariesBy(e,t,o){var r;const i=!e||!t;for(const a in o){const l=o[a],d='number'==typeof l?l:null!==(r=n[l])&&void 0!==r?r:0;if(d<-1){if(-2===d)return!1}else{if(-2===d)return!1;if(i)return!e&&!t;if(0===d){if(e[a]!==t[a])return!1}else if(!s.areEqual(e[a],t[a],d))return!1}}return!0},areEqual(e,t,n=-1){if(e===t)return!0;if(e&&n&&'object'==typeof e){if(!t||'object'!=typeof t)return!1;const o=e.constructor;if(o!==t.constructor)return!1;n--;let r=!1;switch(o){case Object:break;case Array:r=!0;break;case Set:r=!0,e=[...e],t=[...t];break;case Map:if(e.size!==t.size)return!1;for(const[o,r]of e){if(!t.has(o))return!1;if(n?!s.areEqual(t.get(o),r,n):t.get(o)!==r)return!1}return!0;default:const o=e.toString();'[object NodeList]'!==o&&'[object HTMLCollection]'!==o||(r=!0)}if(r){const o=e.length;if(o!==t.length)return!1;for(let r=0;r<o;r++)if(n?!s.areEqual(e[r],t[r],n):e[r]!==t[r])return!1}else{for(const o in t){if(!e.hasOwnProperty(o))return!1;if(n?!s.areEqual(e[o],t[o],n):e[o]!==t[o])return!1}for(const n in e)if(!t.hasOwnProperty(n))return!1}return!0}return!1},deepCopy(e,t=-1){if(!e||!t||'object'!=typeof e)return e;t--;let n=null;switch(e.constructor){case Object:break;case Array:n=e;break;case Set:return new Set(t?[...e].map((e=>s.deepCopy(e,t))):e);case Map:return new Map(t?[...e].map((([e,n])=>[s.deepCopy(e,t),s.deepCopy(n,t)])):e);default:const o=e.toString();'[object NodeList]'!==o&&'[object HTMLCollection]'!==o||(n=[...e])}if(n)return t?n.map((e=>s.deepCopy(e,t))):[...n];if(!t)return Object.assign({},e);const o=new e.constructor;for(const n in e)o[n]=s.deepCopy(e[n],t);return o}};var o=(e,t)=>{var n={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&'function'==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(n[s[o]]=e[s[o]])}return n};var r=(e,t)=>{var n={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&'function'==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(n[s[o]]=e[s[o]])}return n};function i(e,t=null,...n){const i=a.getMixDOMDefType(e);if(!i||t&&t._disable)return null;const l=[];let d=!1,c=0;for(const e of n){let t='string'==typeof e;if(e&&t&&d){l[c-1].domContent+=e;continue}const n=a.newDefFromContent(e);n&&(c=l.push(n),d=t)}if('spread'===i)return function(e,t,n){const{_key:s,_disable:r}=t,i=o(t,['_key','_disable']);let l=a.newDefFromContent(e.call({props:i,children:n},i));if(!l)return null;const d={MIX_DOM_DEF:'fragment',childDefs:[Object.assign({},l)],scopeType:'spread',tag:null};null!=s&&(d.key=s),null!=r&&(d.disabled=r);let c,u=[d],h=!1,f=0;const p=!n.length;for(;c=u[f];){if(f++,!c.childDefs[0])continue;const e=[],t=c.childDefs;c.childDefs=[];for(const s of t){let t;'pass'!==s.MIX_DOM_DEF||s.getContentStream?(t=Object.assign({},s),'fragment'===s.MIX_DOM_DEF&&void 0!==s.withContent&&'function'!=typeof s.withContent&&(p&&(t.childDefs=[]),delete t.withContent),e.push(t)):(t={MIX_DOM_DEF:'fragment',tag:null,childDefs:[...n]},null!=s.key&&(t.key=s.key),h||'copy'===s.contentPassType?t.scopeType='spread-copy':(t.scopeType='spread-pass',h=!0)),c.childDefs.push(t)}u=e.concat(u.slice(f)),f=0}return d}(e,t||{},l);if('fragment'===i&&!l[0])return null;const u='dom'===i&&e||'boundary'===i&&e||'element'===i&&'_'||('content'===i?'':null),h={MIX_DOM_DEF:i,tag:u,childDefs:l},f=!!u;if('fragment'===h.MIX_DOM_DEF)t&&t.withContent&&(h.withContent=t.withContent);else if(t){const{_key:e,_ref:n,_contexts:o,_signals:a,_disable:l}=t,d=r(t,['_key','_ref','_contexts','_signals','_disable']);if(null!=e&&(h.key=e),n){const e=[];if('Ref'===n.constructor.MIX_DOM_CLASS)e.push(n);else for(const t of n)t&&'Ref'===t.constructor.MIX_DOM_CLASS&&-1===e.indexOf(t)&&e.push(t);h.attachedRefs=e}o&&'boundary'===i&&(h.attachedContexts=Object.assign({},o)),a&&(h.attachedSignals=Object.assign({},a)),f&&(h.props='string'==typeof u?s.cleanDOMProps(d):d)}else f&&(h.props={});switch(h.MIX_DOM_DEF){case'portal':{const e=t||{};h.domPortal=e.container||null;break}case'contexts':h.contexts=(t||{}).cascade||null;break;case'element':{const e=t||{};h.domElement=e.element||null,h.domCloneMode=null!=e.cloneMode?'boolean'==typeof e.cloneMode?e.cloneMode?'deep':'':e.cloneMode:null,delete h.props.element,delete h.props.cloneMode;break}}return h}const a={getMixDOMDefType(e){if('string'==typeof e)return'dom';const t=e.MIX_DOM_CLASS;if(!t)return'function'==typeof e?e.length>=2?'boundary':'spread':'';switch(t){case'Component':case'Stream':return'boundary';case'Fragment':case'Portal':case'Element':case'Contexts':case'Host':return t.toLowerCase();default:return''}},newDef:i,newDefFromContent(e){if(e&&'object'==typeof e){if('string'==typeof e.MIX_DOM_DEF)return e;if(e instanceof Node)return{MIX_DOM_DEF:'content',tag:'',childDefs:[],domContent:e};if('Host'===e.constructor.MIX_DOM_CLASS)return{MIX_DOM_DEF:'host',tag:null,host:e,key:e,childDefs:[]};if(Array.isArray(e)||e instanceof HTMLCollection||e instanceof NodeList){const t=[...e].map((e=>a.newDefFromContent(e))).filter((e=>e));return t.length?{MIX_DOM_DEF:'fragment',tag:null,isArray:!0,childDefs:t}:null}e=String(e)}return null!=e?{MIX_DOM_DEF:'content',tag:'',domContent:e,childDefs:[]}:null},newAppliedDefBy(e,t){const n={MIX_DOM_DEF:e.MIX_DOM_DEF,tag:e.tag,childDefs:[],action:'mounted'};return null!=e.key&&(n.key=e.key),'fragment'===n.MIX_DOM_DEF?(e.isArray&&(n.isArray=!0),e.scopeType&&(n.scopeType=e.scopeType),void 0!==e.withContent&&(n.withContent=e.withContent)):'pass'===n.MIX_DOM_DEF?e.getContentStream?(n.getContentStream=e.getContentStream,n.contentPass=e.contentPass||null):n.contentPass=e.contentPass||t||null:e.host&&(n.host=e.host),n},newContentPassDef(e,t){const n={MIX_DOM_DEF:'pass',tag:null,childDefs:[],contentPassType:t?'copy':'pass'};return null!=e?n.key=e:t||(n.key=a.ContentKey),n},newContentCopyDef:e=>a.newContentPassDef(e,!0),ContentKey:{}},l={boundariesWithin(e,t=!0){const n=[];let s,o=[e],r=0;for(;s=o[r];)r++,s.boundaryId&&null!==s.isMounted&&(n.push(s),(t||e===s)&&s.innerBoundaries[0]&&(o=s.innerBoundaries.concat(o.slice(r)),r=0));return n},treeNodesWithin(e,t,n=0,s=!1,o=!1,r){const i=[];let a,l=[e],d=0;const c=e.boundary;for(;a=l[d];)if(d++,!a.boundary||null!==a.boundary.isMounted){if((!t||t[a.type])&&(!r||r(a))){const e=i.push(a);if(n&&e>=n)return i}a.boundary&&!s&&a.boundary!==c||('host'!==a.type||o)&&a.children[0]&&(l=a.children.concat(l.slice(d)),d=0)}return i},rootDOMTreeNodes(e,t=!1,n=!1,s=0){let o=[];for(const r of e.children)if(r.domNode||n)switch(r.type){case'dom':if(o.push(r),s&&o.length>=s)return o;break;case'boundary':case'pass':case'host':if(!t)break;case'contexts':case'root':if(o=o.concat(l.rootDOMTreeNodes(r,t,n,s&&s-o.length)),s&&o.length>=s)return o.slice(0,s)}return o},allDefsIn(e,t,n=0){const s=[];let o,r=[e],i=0;for(;(o=r[i])&&(t&&!t[o.MIX_DOM_DEF]||!(s.push(o)>=n)||!n);)i++,o.childDefs[0]&&(r=o.childDefs.concat(r.slice(i)),i=0);return s},domElementByQuery(e,t,n=!1,s=!1){const o=l.treeNodesWithin(e,{dom:!0},1,n,s,(e=>e.domNode&&e.domNode instanceof Element&&e.domNode.matches(t)))[0];return o&&o.domNode||null},domElementsByQuery:(e,t,n=0,s=!1,o=!1)=>l.treeNodesWithin(e,{dom:!0},n,s,o,(e=>e.domNode&&e.domNode instanceof Element&&e.domNode.matches(t))).map((e=>e.domNode))};var d,c=(e,t,n,s)=>new(n||(n=Promise))(((o,r)=>{function i(e){try{l(s.next(e))}catch(e){r(e)}}function a(e){try{l(s.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((e=>{e(t)}))).then(i,a)}l((s=s.apply(e,t||[])).next())}));function u(e,t,n=!1){let s=0;for(const o of n?e:e.slice()){const r=o[2]||0;!n&&r&d.OneShot?e.splice(s,1):s++,r&d.Deferred?setTimeout((()=>o[0](...o[1]&&t?[...t,...o[1]]:t||o[1]||[])),0):o[0](...o[1]&&t?[...t,...o[1]]:t||o[1]||[])}}function h(e,t,n,s=!1){const o=n&&(n.includes('first')||n.includes('first-true')),r=n&&(o||n.includes('last')),i=n&&n.includes('no-false'),a=n&&n.includes('no-null'),l=[];let c=0;for(const u of s?e:e.slice()){const h=u[2]||0;if(!s&&h&d.OneShot?e.splice(c,1):c++,h&d.Deferred)setTimeout((()=>u[0](...u[1]&&t?[...t,...u[1]]:t||u[1]||[])),0);else{const e=u[0](...u[1]&&t?[...t,...u[1]]:t||u[1]||[]);if(!e&&(void 0===e||i||a&&null==e))continue;if(r?l[0]=e:l.push(e),o&&(e||!n.includes('first-true')))break}}return r?l[0]:l}function f(e,t,n){if(e[1]){let s=[];for(const t of e){s=s.concat(t);for(let e=t.length-1;e>=0;e--)t[e][2]&d.OneShot&&t.splice(e,1)}return h(s,t,n,!0)}return h(e[0],t,n)}function p(e){return class extends e{constructor(...e){super(...e),this.signals={}}listenTo(e,t,n,s=d.None,o){let r=this.signals[e];const i=[t,n||null,s||d.None];null!=o&&i.push(o),r?r.some(((e,n)=>e[0]===t&&(r[n]=i)))||r.push(i):this.signals[e]=r=[i],this.onListener&&this.onListener(e,r.indexOf(i),!0)}unlistenTo(e,t,n){null==e?e=Object.keys(this.signals):'string'==typeof e&&(e=[e]);const s=null!=n;for(const o of e){const e=this.signals[o];if(e){for(let r=e.length-1;r>=0;r--)t&&e[r][0]!==t||s&&e[r][3]!==n||(this.onListener&&this.onListener(o,r,!1),e.splice(r,1));e[0]||delete this.signals[o]}}}isListening(e,t,n){return null==e?Object.keys(this.signals).some((e=>this.isListening(e,t,n))):!!this.signals[e]&&(!(t&&!this.signals[e].some((e=>e[0]===t)))&&!(null!=n&&!this.signals[e].some((e=>e[3]===n))))}}}function m(e){return class extends(p(e)){sendSignal(e,...t){this.signals[e]&&u(this.signals[e],t)}sendSignalAs(e,t,...n){const s='string'==typeof e?[e]:e,o=s.includes('delay')||s.includes('pre-delay'),r=s.includes('first')||s.includes('first-true');return s.includes('await')?new Promise((e=>c(this,void 0,void 0,(function*(){if(o&&(yield this.afterRefresh(s.includes('delay'))),!this.signals[t])return s.includes('last')||r?e(void 0):e([]);let i=(yield Promise.all(h(this.signals[t],n))).filter((e=>!(void 0===e||null==e&&s.includes('no-null')||!e&&s.includes('no-false'))));s.includes('last')?e(i[-1]):r?(s.includes('first-true')&&(i=i.filter((e=>e))),e(i[0])):e(i)})))):o?void(()=>{c(this,void 0,void 0,(function*(){yield this.afterRefresh(s.includes('delay')),this.signals[t]&&(r?h(this.signals[t],n,s):u(this.signals[t],n))}))})():this.signals[t]?h(this.signals[t],n,s):s.includes('last')||r?void 0:[]}afterRefresh(e=!1){return new Promise((t=>setTimeout(t,e?1:0)))}}}(e=>{e[e.OneShot=1]='OneShot',e[e.Deferred=2]='Deferred',e[e.None=0]='None',e[e.All=3]='All'})(d||(d={}));const g=m;class y extends(p(Object)){}class D extends(m(Object)){}class C extends y{constructor(...e){super(...e),this.treeNodes=new Set}onListener(e,t,n){if(this.treeNodes.size){const s=this.signals[e][t],o=s[0];if(n)for(const t of this.getComponents())t.listenTo(e,((...e)=>s[1]?o(t,...e,...s[1]):o(t,...e)),null,s[2],o);else for(const t of this.getComponents())t.unlistenTo(e,o)}}getTreeNode(){return[...this.treeNodes][this.treeNodes.size-1]||null}getTreeNodes(){return[...this.treeNodes]}getElement(e=!1){let t=this.treeNodes.size-1;const n=[...this.treeNodes];for(;t>=0;){const s=n[t];if(s.domNode&&(!e||'dom'===s.type))return s.domNode}return null}getElements(e=!1){let t=[];for(const n of this.treeNodes)n.domNode&&('dom'===n.type?t.push(n.domNode):e||(t=t.concat(l.rootDOMTreeNodes(n,!0).map((e=>e.domNode)))));return t}getComponent(){var e;const t=[...this.treeNodes][this.treeNodes.size-1];return t&&'boundary'===t.type&&(null===(e=t.boundary)||void 0===e?void 0:e.component)||null}getComponents(){var e;const t=[];for(const n of this.treeNodes)'boundary'===n.type&&(null===(e=n.boundary)||void 0===e?void 0:e.component)&&t.push(n.boundary.component);return t}static didAttachOn(e,t){var n;if(!e.treeNodes.has(t))if(e.treeNodes.add(t),'boundary'===t.type){const s=null===(n=t.boundary)||void 0===n?void 0:n.component;for(const t in e.signals)for(const n of e.signals[t]){const[e,o,r]=n;s.listenTo(t,((...t)=>o?e(s,...t,...o):e(s,...t)),null,r,e)}s&&e.signals.didAttach&&u(e.signals.didAttach,[s])}else'dom'===t.type&&t.domNode&&e.signals.domDidAttach&&u(e.signals.domDidAttach,[t.domNode])}static willDetachFrom(e,t){var n;if(e.treeNodes.has(t))if('boundary'===t.type){const s=null===(n=t.boundary)||void 0===n?void 0:n.component;if(s){e.signals.willDetach&&u(e.signals.willDetach,[s]);for(const t in e.signals)for(const n of e.signals[t])s.unlistenTo(t,n[0])}}else'dom'===t.type&&t.domNode&&e.signals.domWillDetach&&u(e.signals.domWillDetach,[t.domNode]);e.treeNodes.delete(t)}}C.MIX_DOM_CLASS='Ref';var v,b=(e,t)=>{var n={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&'function'==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(n[s[o]]=e[s[o]])}return n};class M{constructor(e,t){this.hydrationRoot=t||null,this.paused=e.disableRendering,this.settings=e,this.externalElements=new Set,this.inBrowser='object'==typeof document}pause(){this.paused=!0}resume(){this.paused&&(this.paused=!1,this.hydrationRoot&&this.rehydrate(null,!0))}rehydrate(e=null,t=!1,n=!1,s=!1,o,r){var i,a,d;const c=this.hydrationRoot;if(!c)return void(this.settings.devLogWarnings&&console.warn('__HostRender.rehydrate: Warning: No hydration root assigned. ',this));let u=null;const h={};if(e&&(u={tag:(null===(i=e.tagName)||void 0===i?void 0:i.toLowerCase())||'',node:e,parent:null,used:!0},e.childNodes[0])){let t,n=[[[...e.childNodes],u]],s=0;for(;t=n[s];){s++;const[e,o]=t;o.children||(o.children=[]);let r=[];for(const t of e){const e={tag:(null===(a=t.tagName)||void 0===a?void 0:a.toLowerCase())||'',node:t,parent:o},n=t instanceof Element?t.getAttribute('_key'):null;null!=n&&(e.key=n,(h[e.tag]||(h[e.tag]=[])).push(e)),o.children.push(e),t.childNodes[0]&&r.push([[...t.childNodes],e])}r[0]&&(n=r.concat(n.slice(s)),s=0)}}const f=new Set(this.externalElements);e&&f.add(e);let p,m=[[c,u]],g=0;const y=[];for(;p=m[g];){g++;let[e,s]=p;if('dom'===e.type){let i=e.domNode;const a=M.getTreeNodeMatch(e,s,h,f,o,r);if(a){let t=null;a instanceof Node?t=a:(s=a,s.used=!0,t=s.node),!t||e.domNode&&!n||(i=t)}i&&f.add(i);const l={treeNode:e};let d=t;if(i!==e.domNode&&(d=!0,e.domNode?i&&(l.swap=i):l.create=!0),!l.create&&i){const[t,n]=M.findInsertionNodes(e);i.parentNode===t&&i.nextSibling===n||(l.move=!0),'content'===e.def.MIX_DOM_DEF?l.content=!0:(d&&(e.domProps=M.readFromDOM(i)),l.update=!0)}(l.create||l.swap||l.move||l.update||l.content)&&y.push(l)}e.children[0]&&(m=e.children.map((e=>[e,s])).concat(m.slice(g)),g=0)}if(this.settings.disableRendering||(this.paused=!1),s&&e){let t,n=e===c.domNode?l.rootDOMTreeNodes(c.children[0],!0).map((e=>e.domNode)).filter((e=>e)):[...e.childNodes],s=0;for(;t=n[s];)s++,f.has(t)?t.childNodes[0]&&(n=[...t.childNodes,...n.slice(s)],s=0):null===(d=t.parentNode)||void 0===d||d.removeChild(t)}if(y[0]&&this.applyToDOM(y),this.pausedPending){const e=this.pausedPending.filter((e=>e.treeNode.domNode&&!f.has(e.treeNode.domNode)));delete this.pausedPending,e[0]&&this.applyToDOM(e)}}applyToDOM(e){const t=this.settings;if(t.devLogRenderInfos&&console.log('__HostRender.applyToDOM: Dev-log: Received rendering infos'+(this.paused?' (while paused)':'')+': ',e),this.paused){const t=e.filter((e=>e.remove));return void(t[0]&&(this.pausedPending=(this.pausedPending||[]).concat(t)))}let n=null,s=null,o=null;for(const r of e){const e=r.treeNode,i=e.def.attachedSignals,a=e.def.attachedRefs;if(r.remove){if('dom'===e.type&&e.domNode){const t=e.domNode,n=t.parentNode;let r=!1;if((null==i?void 0:i.domWillUnmount)&&i.domWillUnmount(t)&&(r=!0),a)for(const n of a)n.signals.domWillUnmount&&h(n.signals.domWillUnmount,[t],['no-false','last'])&&(r=!0),C.willDetachFrom(n,e);r?o?o.push(t):o=[t]:!n||s&&-1!==s.indexOf(n)||o&&o.some((e=>e.contains(t)))||n.removeChild(t);const l='element'===e.def.MIX_DOM_DEF;(l||'content'===e.def.MIX_DOM_DEF)&&this.externalElements.delete(t),l||(s||(s=[])).push(t),e.domNode=null,M.updateDOMChainBy(e,null)}continue}let l=!1,d=!1;if(r.refresh&&e.domNode&&e.domProps&&(e.domProps='read'===r.refresh?M.readFromDOM(e.domNode):{},l=!0),r.create)switch(e.type){case'dom':const t=this.createDOMNodeBy(e);t&&(e.domNode=t,d=!0);break;case'portal':e.domNode=e.def.domPortal||null}if(d||r.move)if('host'===e.type){const t=e.def.host||null;t&&t.services.refreshRoot(!1,null,null),e.domNode=e.parent&&t&&t.getRootElement()||null,M.updateDOMChainBy(e,e.domNode)}else e.domNode&&(n||(n=[])).push(r);if(r.swap){const n=!0!==r.swap,s=e.domNode;let o=n?r.swap:('portal'===e.type?e.def.domPortal:e.def.domElement)||null;if(s!==o){if(!n&&'dom'===e.type){const n=e,r=s&&s.parentNode;if(o&&(o=this.getApprovedNode(o,n),o)){let[t,n]=r?[r,s]:M.findInsertionNodes(e);t&&t.insertBefore(o,n)}if(s){if(this.externalElements.delete(s),n.domProps&&s instanceof Element)for(const e in n.domProps){const t=M.LISTENER_PROPS[e];t&&s.removeEventListener(t,n.domProps[e])}r&&r.removeChild(s)}n.domProps&&(n.domProps=o&&'read'===t.renderDOMPropsOnSwap?M.readFromDOM(o):{},l=!0)}for(const t of e.children){const e=t.domNode;e&&(e.parentNode&&e.parentNode.removeChild(e),o&&o.appendChild(e))}e.domNode=o,M.updateDOMChainBy(e,o)}}if(r.content&&'dom'===e.type&&e.domNode){const n=e.def.domContent,s=e.domNode;let o=s;if('content'===e.def.MIX_DOM_DEF){if(e.def.domHTMLMode&&null!=n&&''!==n)o=M.domNodeFrom(n.toString(),e.def.tag||t.renderHTMLDefTag,!0),o&&e.domProps&&(l=!0,e.domProps={});else{const e=null==n?'':(t.renderTextHandler?t.renderTextHandler(n):n).toString();3!==s.nodeType&&this.inBrowser?o=document.createTextNode(e):s.textContent=e}}else if(n instanceof Node){const e=n.parentNode;e&&e.removeChild(n)}else s.textContent='';if(o&&s!==o){const t=s.parentNode;t&&(e.domNode=o,t.insertBefore(o,s),t.removeChild(s)),M.updateDOMChainBy(e,e.domNode)}if((null==i?void 0:i.domDidContent)&&i.domDidContent(e.domNode,null!=n?n:null),a)for(const t of a)t.signals.domDidContent&&u(t.signals.domDidContent,[e.domNode,null!=n?n:null])}if((d||l||r.update)&&'dom'===e.type){const[n,s,o]=M.domApplyProps(e,t.devLogWarnings);if(e.domProps=n,o&&r.update&&s&&((null==i?void 0:i.domDidUpdate)&&i.domDidUpdate(s,o),a))for(const e of a)e.signals.domDidUpdate&&u(e.signals.domDidUpdate,[s,o])}r.emptyMove&&M.updateDOMChainBy(e,null,!0)}if(n){const e=[];let t=null,s=n.length;for(;s--;){const o=n[s],r=o.treeNode,i=r.domNode;if(i){const n=i.parentNode,s=i.nextSibling,[a,l]=i?M.findInsertionNodes(r):[null,null];a===n&&l===s||(a&&e.push([i,a,l]),(r.def.attachedRefs||r.def.attachedSignals)&&(t||(t=[])).push([!o.move,o.treeNode,n,s]),n&&n.removeChild(i))}M.updateDOMChainBy(r,i)}if(e[0])for(const t of e)t[1].insertBefore(t[0],t[2]);if(t){let e=t.length;for(;e--;){const[n,s,o,r]=t[e],{attachedSignals:i,attachedRefs:a}=s.def,l=s.domNode;if(i&&(n?i.domDidMount&&i.domDidMount(l):i.domDidMove&&i.domDidMove(l,o,r)),a)for(const e of a)n?(C.didAttachOn(e,s),e.signals.domDidMount&&u(e.signals.domDidMount,[l])):e.signals.domDidMove&&u(e.signals.domDidMove,[l,o,r])}}}}getApprovedNode(e,t){let n=e;const s=null!=t.def.domCloneMode?t.def.domCloneMode:this.settings.duplicateDOMNodeBehaviour;return('always'===s||this.externalElements.has(e))&&(n=this.settings.duplicateDOMNodeHandler?this.settings.duplicateDOMNodeHandler(e,t):s?e.cloneNode('deep'===s||'always'===s):null),n&&this.externalElements.add(n),n}createDOMNodeBy(e){const t=e.def.tag;if('string'!=typeof t)return null;if('_'===t)return e.def.domElement&&this.getApprovedNode(e.def.domElement,e)||null;const n=e.def.domContent;if(n instanceof Node)return this.getApprovedNode(n,e);const s=this.settings;if(e.def.domHTMLMode&&null!=n&&''!==n)return M.domNodeFrom(n.toString(),t||s.renderHTMLDefTag,!0);if(t)return this.inBrowser?'svg'===t||e.parent&&e.parent.domNode&&void 0!==e.parent.domNode.ownerSVGElement?document.createElementNS(s.renderSVGNamespaceURI||'http://www.w3.org/2000/svg',t):document.createElement(t):null;let o=null,r='',i='';if(null!=n){i=(s.renderTextHandler?s.renderTextHandler(n):n).toString();const e=s.renderTextTag;if(e)if('string'==typeof e)r=e;else if('function'==typeof e){const t=e(n);t instanceof Node&&(o=t)}}if(!o){if(!this.inBrowser)return null;o=r?document.createElement(r):document.createTextNode(i)}return r&&i&&(o.textContent=i),o}static findInsertionNodes(e){let t=null,n=e.parent;for(;n;){if(!(M.PASSING_TYPES[n.type]||'root'===n.type&&n.parent)){t=n.domNode;break}n=n.parent}if(!t)return[null,null];let s=null,o=e;for(;o&&(n=o.parent,n);){let e,r=n.children.indexOf(o)+1;for(;e=n.children[r];){if(e.domNode&&'portal'!==e.type){s=e.domNode;break}r++}if(s||n.domNode===t)break;o=n}return[t,s]}static updateDOMChainBy(e,t,n=!1){let s=e,o=n?e:e.parent,r=t;for(;o&&(M.PASSING_TYPES[o.type]||o===s);){if(o.children[0]!==s&&o!==s){let e=!1,t=o.children.indexOf(s)-1;for(;t>=0;){if(o.children[t].domNode){e=!0;break}t--}if(e)break}if(!r){let e,t=o.children.indexOf(s)+1;for(;e=o.children[t];){if(e.domNode&&'portal'!==e.type){r=e.domNode;break}t++}if(r&&o.domNode===r)break}o.domNode=r,s=o,o=o.parent}}static readFromDOM(e){const t={};if(!(e instanceof Element))return t;for(const n of e.getAttributeNames())t['class'===n?'className':n]=e.getAttribute(n);const n=e.style.cssText;n&&(t.style=s.cleanDOMStyle(n));const o=e.dataset;if(o&&Object.keys(o).length){t.data={};for(const e in o)t.data[e]=o[e]}return t}static domNodeFrom(e,t='div',n=!1){const s=t instanceof Element?t:'object'==typeof document?document.createElement(t):null;return s?(s.innerHTML=e,n||s.children[1]?s:s.children[0]):null}static domApplyProps(e,t=!1){const n=e.domNode instanceof Element?e.domNode:null,o={},r=e.domProps||{},i=e.def.props||{},a=s.getDictionaryDiffs(r,i);if(!a)return[i,n];const l={};for(const d in a){const c=M.SPECIAL_PROPS[d];if(c){if('render'===c)t&&console.warn('__HostRender.domApplyProps: Warning: Is using an ignored dom prop: ',d,' for treeNode: ',e);else if('className'===d){const e=s.getClassNameDiffs(r.className,i.className);if(e){if(l.classNames=e,n)for(const t in e)n.classList[e[t]?'add':'remove'](t);i.className?o.className=i.className:delete o.className}}else{const e=i[d],t=s.getDictionaryDiffs(r[d]||{},e||{});if(t){if(l[d]=t,n)if('data'===d){const e=n.dataset;if(e)for(const n in t)void 0!==t[n]?e[n]=t[n]:delete e[n]}else{const e=n.style;if(e)for(const n in t)e[n]=null!=t[n]?t[n]:null}e?o[d]=e:delete o[d]}}continue}const u=a[d],h=void 0!==u,f=M.LISTENER_PROPS[d];if(f){if(l.listeners||(l.listeners={}),l.listeners[d]=u,n){const e=r[d];e&&n.removeEventListener(f,e),h&&n.addEventListener(f,u)}}else l.attributes||(l.attributes={}),l.attributes[d]=u,n&&(h?n.setAttribute(d,u):n.removeAttribute(d));h?o[d]=u:delete o[d]}for(const e in l)return[o,n,l];return[o,n]}static readAsString(e){const t=e.def;if(!t)return'';let n=t.tag,o='';if('string'!=typeof n){for(const t of e.children)o+=M.readAsString(t);return o}let r=null;if(n)'_'===n&&(r=t.domElement||null);else{const e=t.domContent;e&&(e instanceof Node?r=e:o+=e.toString())}if(!n&&!r)return o;let i=e.domProps;if(r){if(r instanceof Element&&(n=r.tagName.toLowerCase()||''),!n)return r.textContent||'';const e=M.readFromDOM(t.domElement),{className:s,style:o,data:a}=e,l=b(e,['className','style','data']);if(s&&(i.className=i.className?i.className+' '+s:s),o){i.style=i.style||{};for(const e in o)i.style[e]=o[e]}if(a){i.data=i.data||{};for(const e in a)i.data[e]=a[e]}for(const e in l)i[e]=l[e]}const{className:a,style:l,data:d}=i,c=b(i,['className','style','data']);if(o+='<'+n,a&&(o+=' class="'+a+'"'),l){let e='';for(const t in l)e+=t+': '+l[t]+';';e&&(o+=' style="'+e+'"')}if(d)for(const e in d)o+=' data-'+s.decapitalize(e,'-')+'="'+d[e].toString()+'"';for(const e in c)M.LISTENER_PROPS[e]||M.SPECIAL_PROPS[e]||(o+=' '+e+'="'+c[e].toString()+'"');if(M.SIMPLE_TAGS[n])o+='/>';else{o+='>';for(const t of e.children)o+=M.readAsString(t);o+='</'+n+'>'}return o}static getTreeNodeMatch(e,t,n,s,o,r){const i=e.def.tag,a=e.def.key;if(r){const n=r(t,e,i,a);if(n){if((n instanceof Element?n.tagName.toLowerCase():'')===i&&(n instanceof Node?!(null==s?void 0:s.has(n)):!(null==s?void 0:s.has(n.node))&&M.isVirtualItemOk(e,n,t,o)))return n}}const l=null!=a;if(t)for(const n of t.used?t.children||[]:[t])if(!n.used&&n.tag===i&&(l?n.key===a:null==n.key)&&!(null==s?void 0:s.has(n.node))&&(!o||o(n,e,i,a)))return n;if(n&&l){const r=n[i];if(r)for(const n of r)if(!n.used&&n.key===a&&!(null==s?void 0:s.has(n.node))&&M.isVirtualItemOk(e,n,t,o))return n}return null}static isVirtualItemOk(e,t,n,s){if(t.tag!==e.def.tag)return!1;const o=e.def;if(n){let r=t;for(;r;){if(r===n)return!s||s(t,e,o.tag,o.key);r=r.parent}}else if(!s||s(t,e,o.tag,o.key))return!0;return!1}}M.SIMPLE_TAGS=['img'],M.SPECIAL_PROPS={innerHTML:'render',outerHTML:'render',textContent:'render',innerText:'render',outerText:'render',style:'other',data:'other',className:'other'},M.PASSING_TYPES={boundary:!0,pass:!0,contexts:!0,host:!0,fragment:!0},M.LISTENER_PROPS=['Abort','Activate','AnimationCancel','AnimationEnd','AnimationIteration','AnimationStart','AuxClick','Blur','CanPlay','CanPlayThrough','Change','Click','Close','ContextMenu','CueChange','DblClick','Drag','DragEnd','DragEnter','DragLeave','DragOver','DragStart','Drop','DurationChange','Emptied','Ended','Error','Focus','FocusIn','FocusOut','GotPointerCapture','Input','Invalid','KeyDown','KeyPress','KeyUp','Load','LoadedData','LoadedMetaData','LoadStart','LostPointerCapture','MouseDown','MouseEnter','MouseLeave','MouseMove','MouseOut','MouseOver','MouseUp','Pause','Play','Playing','PointerCancel','PointerDown','PointerEnter','PointerLeave','PointerMove','PointerOut','PointerOver','PointerUp','Progress','RateChange','Reset','Resize','Scroll','SecurityPolicyViolation','Seeked','Seeking','Select','Stalled','Submit','Suspend','TimeUpdate','Toggle','TouchCancel','TouchEnd','TouchMove','TouchStart','TransitionCancel','TransitionEnd','TransitionRun','TransitionStart','VolumeChange','Waiting','Wheel'].reduce(((e,t)=>(e['on'+t]=t.toLowerCase(),e)),{});class O{constructor(e){}}O.MIX_DOM_CLASS='Fragment';class _{constructor(e){}}_.MIX_DOM_CLASS='Portal';class x{constructor(e){}}x.MIX_DOM_CLASS='Element';class N{constructor(e){}render(){return null}}N.MIX_DOM_CLASS='Empty';const P=((v=class extends N{static isStream(){return!1}}).Content=null,v.ContentCopy=null,v.copyContent=e=>null,v.withContent=(...e)=>null,v);class S{constructor(e){}}S.MIX_DOM_CLASS='Contexts';var w=(e,t)=>{var n={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&'function'==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(n[s[o]]=e[s[o]])}return n};class T{constructor(e){this.host=e,this.renderer=new M(e.settings,e.groundedTree),this.bIdCount=0,this.updateTimer=null,this.renderTimer=null,this.updatesPending=new Set,this.postRenderInfos=[],this.postBoundaryCalls=[]}createBoundaryId(){return'h-'+this.host.constructor.idCount.toString()+'-b-'+(this.bIdCount++).toString()}clearTimers(e=!1){e||this.runUpdates(null),null!==this.updateTimer&&(clearTimeout(this.updateTimer),this.updateTimer=null),null!==this.renderTimer&&(clearTimeout(this.renderTimer),this.renderTimer=null)}createRoot(e){return this.rootDef=a.newDefFromContent(e),(e,t)=>()=>this._rootIsDisabled?null:this.rootDef}updateRoot(e,t,n){this.rootDef=a.newDefFromContent(e),this.host.rootBoundary.update(!0,t,n)}refreshRoot(e=!1,t,n){const s=!this._rootIsDisabled,o=this.host,r=!(o.settings.onlyRunInContainer&&!o.groundedTree.domNode&&!o.groundedTree.parent);if(r?delete this._rootIsDisabled:this._rootIsDisabled=!0,!e&&r&&s){if(r&&s){const e=o.rootBoundary?l.rootDOMTreeNodes(o.rootBoundary.treeNode,!0).map((e=>({treeNode:e,move:!0}))):[];this.absorbChanges(e,null,n)}}else o.rootBoundary.update(!0,t,n)}clearRoot(e=!1){this.clearTimers(e),this.rootDef=null}getRootDef(e){return this.rootDef&&(e?Object.assign({},this.rootDef):this.rootDef)}onContextPass(e){const t=this.host.rootBoundary;t._outerContextsWere||(t._outerContextsWere=t.outerContexts),t.outerContexts=Object.assign({},e);const n=T.afterOuterContexts(t);for(const e of n)e._preUpdates&&this.absorbUpdates(e,{});this.runUpdates()}hasPending(e=!0,t=!0,n=!0){return e&&null!==this.updateTimer||t&&null!==this.renderTimer||n&&!!this.host.dataKeysPending||!1}cancelUpdates(e){this.updatesPending.delete(e)}absorbUpdates(e,t,n=!0,s,o){null!==e.isMounted&&(T.preSetUpdates(e,t),e._renderState?e._renderState='re-updated':(this.updatesPending.add(e),n&&this.triggerUpdates(s,o)))}triggerUpdates(e,t){void 0!==t&&(null===t||void 0===this._forcePostTimeout||null!==this._forcePostTimeout&&t<this._forcePostTimeout)&&(this._forcePostTimeout=t),this._isUpdating||this.refreshWithTimeout('update',e)}flushDataKeys(){if(this.host.dataKeysPending){const e=this.host.dataKeysPending;this.host.dataKeysPending=null;for(const t of l.boundariesWithin(this.host.rootBoundary))if(t.component.hostDataListeners){const n=[];for(const[s,o]of t.component.hostDataListeners)(!0===e||e.some((e=>o.some((t=>t===e||t.startsWith(e+'.')||e.startsWith(t+'.'))))))&&n.push(s);n[0]&&this.absorbUpdates(t,{host:n},!1)}}}runUpdates(e){for(this.updateTimer=null,this._isUpdating=!0,e=void 0!==e?e:void 0!==this._forcePostTimeout?this._forcePostTimeout:this.host.settings.renderTimeout,delete this._forcePostTimeout,this.host.dataKeysPending&&this.flushDataKeys();this.updatesPending.size;){let e=[...this.updatesPending];this.updatesPending.clear(),e[1]&&I.sortBoundaries(e);let t=[],n=[];for(const s of e){const e=this.updateBoundary(s);e&&(t=t.concat(e[0]),n=n.concat(e[1]))}t[0]&&this.postRenderInfos.push(t),n[0]&&(this.host.settings.useImmediateCalls?T.callBoundaryChanges(n):this.postBoundaryCalls.push(n)),this.host.dataKeysPending&&this.flushDataKeys()}this.host.signals.onUpdate&&u(this.host.signals.onUpdate),this.refreshWithTimeout('render',e),delete this._isUpdating}updateBoundary(e,t=!1,n,s,o=!1){var r,i,a,d;let c=!!t,f='all'===t,p=[],m=[];const g=e.component,y=g.contextAPI;if(e._preUpdates){const t=e._preUpdates.host;if(t&&g.hostDataListeners)for(const[e,n]of g.hostDataListeners.entries())t.includes(e)&&e(...n.map(((e,t)=>this.host.getInData(e))));y&&e._preUpdates.contextual&&y.askDataBuildBy(e._preUpdates.contextual,!0)}const D=g.constructor.api;if(D&&D.getMixedProps&&(!1===e.isMounted||(null===(r=e._preUpdates)||void 0===r?void 0:r.props))&&(e.isMounted?e._preUpdates?e._preUpdates.state=g.state:e._preUpdates={state:g.state}:D.onBuildProps&&!D.builtProps&&(D.builtProps=D.onBuildProps(null)),g.state=D.getMixedProps(g)),e.isMounted){g.signals.beforeUpdate&&u(g.signals.beforeUpdate);const s=e._preUpdates;if(delete e._preUpdates,!s&&!t)return null;const o=s||{},{force:r,contextual:D}=o,C=w(o,['force','contextual']),v={};if(C.props&&(v.props=e._outerDef.props),C.state&&(v.state=g.state||{}),C.children&&(v.children=(null===(i=e.closure.envelope)||void 0===i?void 0:i.targetDef.childDefs)||[]),C.streamed){v.streamed=new Map;for(const e of C.streamed.keys())v.streamed.set(e,(null===(d=null===(a=e.constructor.closure)||void 0===a?void 0:a.envelope)||void 0===d?void 0:d.targetDef.childDefs)||[])}if(r)c=!0,'all'===r&&(f=!0);else if(!c){const t=g.signals.shouldUpdate?h(g.signals.shouldUpdate,[g,v,C],['first-true','no-false']):null;(!0===t||null==t&&T.shouldUpdateBy(e,v,C))&&(c=!0)}const b='moved'===e._outerDef.action;if(b&&m.push([e,'moved']),c&&m.push([e,'updated',v,C]),b){if(y){const e=y.getContexts();for(const t in e){const n=e[t];n&&n.services.onComponentMove(g,t)}}for(const t of l.rootDOMTreeNodes(e.treeNode,!0,!0)){if(n){if(-1!==n.indexOf(t))continue;n.push(t)}p.push({treeNode:t,move:!0})}}g.signals.preUpdate&&u(g.signals.preUpdate,[v,C,c])}else{if(null===e.isMounted)return null;m.push([e,'mounted']),c=!0,e._preUpdates&&delete e._preUpdates}if(c){const[t,n]=I.runBoundaryUpdate(e,f);p=p.concat(t),m=m.concat(n)}else if(e._outerContextsWere){let t=T.afterOuterContexts(e);if(t[0]===e&&(t=t.slice(1)),t[0])if(s&&s.size){o=!1;for(const e of t)s.add(e)}else s=new Set(t)}if(g.wrappers)for(const e of g.wrappers){if(e.api.onBuildProps){const t=e.api.builtProps;if(e.api.builtProps=e.api.onBuildProps(t),t===e.api.builtProps)continue}if(e.api.components.size){s||(s=new Set),o=!1;for(const t of e.api.components)T.preSetUpdates(t.boundary,{props:t.props}),s.add(t.boundary)}}const C='Stream'===e.component.constructor.MIX_DOM_CLASS;if(s&&s.size){const e=T.updateInterested(s,!o);p=p.concat(e[0]),m=m.concat(e[1])}return C&&e.component.refreshSource(),p[0]||m[0]?[p,m]:null}absorbChanges(e,t,n){e&&this.postRenderInfos.push(e),t&&(this.host.settings.useImmediateCalls?T.callBoundaryChanges(t):this.postBoundaryCalls.push(t)),this.refreshWithTimeout('render',n)}runRender(){this.renderTimer=null;for(const e of this.postRenderInfos)e[0]&&this.renderer.applyToDOM(e);this.postRenderInfos=[];for(const e of this.postBoundaryCalls)e[0]&&T.callBoundaryChanges(e);this.postBoundaryCalls=[],this.host.signals.onRender&&u(this.host.signals.onRender)}refreshWithTimeout(e,t){'update'===e?this.updateTimer=s.refreshWithTimeout(this,this.runUpdates,this.updateTimer,this.host.settings.updateTimeout,t):this.renderTimer=s.refreshWithTimeout(this,this.runRender,this.renderTimer,this.host.settings.renderTimeout,t)}static preSetUpdates(e,t){var n,s,o;const r=e.component;let i=e._preUpdates;if(i||(e._preUpdates=i={}),t.props&&(i.props||(i.props=e._outerDef.props||{}),e._outerDef.props=t.props,r.props=t.props),t.state&&(i.state||(i.state=r.state),r.state=t.state),t.children&&e.closure&&(i.children||(i.children=(null===(n=e.closure.envelope)||void 0===n?void 0:n.targetDef.childDefs)||[])),t.streamed){i.streamed||(i.streamed=new Map);for(const e of t.streamed.keys())i.streamed.set(e,(null===(o=null===(s=e.constructor.closure)||void 0===s?void 0:s.envelope)||void 0===o?void 0:o.targetDef.childDefs)||[])}t.contextual&&(i.contextual=i.contextual?[...new Set([...t.contextual,...i.contextual])]:[...t.contextual]),t.host&&(i.host=i.host?[...new Set([...t.host,...i.host])]:[...t.host]),t.force&&(i.force='all'!==t.force&&'all'!==i.force||'all')}static updateInterested(e,t=!0){let n=[],s=[];t&&e.size>1&&I.sortBoundaries(e);for(const t of e){if(!t._preUpdates)continue;const e=t.host.services.updateBoundary(t);e&&(n=n.concat(e[0]),s=s.concat(e[1]))}return[n,s]}static afterOuterContexts(t){var n;const s=[];if(!t._outerContextsWere)return s;const o={},r=t.outerContexts;for(const e in t.outerContexts){const n=t._outerContextsWere[e];t.outerContexts[e]!==n&&(o[e]=n)}for(const e in t._outerContextsWere)void 0===t.outerContexts[e]&&(o[e]=t._outerContextsWere[e]);t.outerContexts=t._outerContextsWere,delete t._outerContextsWere;let i,a=[[t.treeNode,o]],l=0;for(;i=a[l];){l++;const t=i[0],o=i[1];if('host'===t.type){const e=t.def.host;if(e&&e.settings.welcomeContextsUpRoot){const t=e.rootBoundary,n=Object.assign({},t.outerContexts);let s=!1;for(const e in o)if(t.outerContexts[e]===o[e]){s=!0;const t=r[e];t?n[e]=t:delete n[e]}s&&e.services.onContextPass(n)}}else if(t.boundary){const i=t.boundary,d=null===(n=i.component)||void 0===n?void 0:n.contextAPI,c={};let u=0,h=null;for(const t in o)if(i.outerContexts[t]===o[t]){const n=r[t],o=c[t];if(n?i.outerContexts[t]=n:delete i.outerContexts[t],c[t]=o,u|=e.Otherwise,h||(h=[]),h.push(t),d){if(n!==d.getContext(t))continue;u|=I.helpUpdateContext(d,t,n,o),!s.includes(i)&&[...d.dataListeners.values()].some((([e])=>e.some((e=>e===t||e.startsWith(t+'.')))))&&s.push(i)}}if(delete i._outerContextsWere,!u||!h)continue;i.component&&T.shouldUpdateContextually(u)&&(i._preUpdates||(i._preUpdates={}),i._preUpdates.contextual=h),t.children[0]&&(a=t.children.map((e=>[e,c])).concat(a.slice(l)),l=0)}else if(t.children[0]){const e='contexts'===t.type?t.def.contexts:null;let n=o;if(e){const t=[];for(const n in o)void 0!==e[n]&&t.push(n);if(t[0]){n=Object.assign({},o);for(const e of t)delete n[e];void 0===Object.keys(n)[0]&&(n=null)}}n&&(a=t.children.map((e=>[e,n])).concat(a.slice(l)),l=0)}}return s}static shouldUpdateContextually(t){return 0!=(t&(e.DoRefresh|e.Data))}static shouldUpdateBy(e,t,o){var r,i;const a=e.host.settings,l=e.component,d=l.updateModes||{};if(l.constructor.api){const e=l.constructor.api.updateModes;if(e)for(const t in e)void 0===d[t]&&(d[t]=e[t])}let c=!1;if(o)for(const e in o){c=!0;const l=null!==(r=d[e])&&void 0!==r?r:a.updateComponentModes[e],u='number'==typeof l?l:null!==(i=n[l])&&void 0!==i?i:0;if(u<-1){if(-2===u)return!0}else if(0===u){if(o[e]!==t[e])return!0}else if(!s.areEqual(o[e],t[e],u))return!0}return!c&&a.shouldUpdateWithNothing}static callBoundaryChanges(e){for(const t of e){const[e,n,s,o]=t,r=e.component,i='mounted'===n?'didMount':'moved'===n?'didMove':'didUpdate';r.signals[i]&&u(r.signals[i],'updated'===n?[s||{},o||{}]:void 0)}}}T.FLAGS_LISTENER_ONE_SHOT=1;const I={SEARCH_TAG_BY_TYPE:{fragment:1,portal:2,pass:3,contexts:4,host:5},runContentPassUpdate(e,t=!1){const[n,s,o]=I.assignTreeNodesForPass(e);let[r,i]=I.applyDefPairs(e,n,t);if(s[0]){const t=new Set;for(const e of s)e.sourceBoundary||(e.def&&t.add(e.def),e.parent=null);if(t.size){const n=I.cleanUpBoundaryDefs(t,e.host.settings.devLogCleanUp);r=n[0].concat(r),i=n[1].concat(i)}}return o[0]&&(r=o.map((e=>({treeNode:e,emptyMove:!0}))).concat(r)),e.isMounted=!0,[r,i]},runBoundaryUpdate(e,t=!1){let n,s,o=null,r=e._innerDef;e.boundaryId?(o=a.newDefFromContent(e.render()),o&&!r&&(r=a.newAppliedDefBy(o,e.closure))):o=e.targetDef;const[i,l]=r?I.buildDefMaps(r):[new Map,new Set],d=[];if(o){const a=[],c=I.pairDefs(e,o,r,i,l,a,d);if(e._innerDef=c[0][1],[n,s]=I.applyDefPairs(e,c,t),a[0])for(const e of a){const t=e.treeNode;t&&null===t.sourceBoundary&&l.add(e)}}else n=[],s=[],!r&&e.isMounted||d.push(e.treeNode),e.innerBoundaries=[],e.treeNode.children=[],e._innerDef=null;if(l.size){const t=I.cleanUpBoundaryDefs(l,e.host.settings.devLogCleanUp);n=t[0].concat(n),s=t[1].concat(s)}return d[0]&&(n=d.map((e=>({treeNode:e,emptyMove:!0}))).concat(n)),e.isMounted||(e.isMounted=!0),delete e._outerContextsWere,[n,s]},applyDefPairs(n,o,r=!1){var i,a;const d=n.boundaryId?n:n.sourceBoundary,c=[],u=n.host.settings.preCompareDOMProps;n.innerBoundaries=[];let h=[[],[]];for(const f of o){const[o,p,m,g]=f,y='mounted'===p.action;if(!y&&'moved'===p.action)switch(p.MIX_DOM_DEF){case'contexts':case'fragment':for(const e of l.rootDOMTreeNodes(m,!0,!0))-1===c.indexOf(e)&&(c.push(e),h[0].push({treeNode:e,move:!0}));break;case'host':p.host&&p.host.groundedTree.parent===m&&h[0].push({treeNode:m,move:!0})}if('fragment'===p.MIX_DOM_DEF)continue;if('pass'===m.type){if('pass'!==p.MIX_DOM_DEF)continue;let e=p.contentPass,t=he.key;if(p.getContentStream){const n=p.getContentStream();t=null===(i=n.Content)||void 0===i?void 0:i.key;const s=n.closure||null;e!==s&&(e&&(null===(a=e.streamLinks)||void 0===a||a.delete(p),I.mergeChanges(h,e.contentUngrounded(p))),p.contentPass=s,e=s,s&&(s.streamLinks?s.streamLinks.add(p):s.streamLinks=new Set([p])))}e&&I.mergeChanges(h,e.contentGrounded(p,n,m,p.key!==t?p.key:null)),m.boundary&&n.innerBoundaries.push(m.boundary);continue}const D=p.props;let v=!1;o.props&&p.props!==o.props&&(m.boundary&&T.preSetUpdates(m.boundary,{props:o.props}),p.props=o.props||{});let b=!1;switch(p.MIX_DOM_DEF){case'content':b=!0;const e=o.domHTMLMode;v=p.domContent!==o.domContent||e!==o.domHTMLMode,v&&(p.domContent=o.domContent,void 0!==e?p.domHTMLMode=e:delete p.domHTMLMode);break;case'element':b=!0,p.domElement!==o.domElement&&(y||h[0].push({treeNode:m,swap:!0}),p.domElement=o.domElement||null),p.domCloneMode=null!=o.domCloneMode?o.domCloneMode:null;break;case'dom':b=!0;break;case'portal':p.domPortal!==o.domPortal&&(h[0].push({treeNode:m,[y?'create':'swap']:!0}),p.domPortal=o.domPortal||null);break;case'contexts':{const e=p.contexts,t=o.contexts||null;if(e!==t){if(e)for(const n in e){const s=e[n];if(s&&s!==(t&&t[n]||null)){s.onRemoveFrom&&s.onRemoveFrom(m,n);const e=s.inTree.get(m);e&&e.size>1?e.delete(n):s.inTree.delete(m)}}for(const n in t){const s=t[n];if(s&&s!==(e&&e[n]||null)){s.onInsertInto&&s.onInsertInto(m,n);const e=s.inTree.get(m);e?e.add(n):s.inTree.set(m,new Set([n]))}}p.contexts=t}break}case'boundary':if(y){const e=new ne(n.host,p,m,d);e.parentBoundary=n,e.outerContexts=Object.assign({},g),m.boundary=e}break;case'host':if(p.host){const e=p.host;let t=e;if('mounted'===p.action&&e.groundedTree.parent){const n=t.settings.duplicatableHost;if('function'==typeof n){const e=n(p.host,m);if(!e)break;if('object'==typeof e&&(t=e,t.groundedTree.parent||t.sourceHost))break}else if(!n)break;t===e&&(t=new oe(e.services.getRootDef(!0),null,e.settings)),t.sourceHost=e.sourceHost||e,e.ghostHosts||(e.ghostHosts=new Set),e.ghostHosts.add(t),p.host=t}t.groundedTree.parent=m,m.children=[t.groundedTree],h[0].push({treeNode:m,move:!0}),t.settings.welcomeContextsUpRoot&&t.services.onContextPass(g);break}}if(b){if(y)h[0].push({treeNode:m,create:!0});else{const e='moved'===p.action&&-1===c.indexOf(m),t=!!p.tag&&(!u||'if-needed'===u&&(v||e)||!s.equalDOMProps(D||{},o.props||{}));if(t||v||e){const n={treeNode:m};t&&(n.update=!0),v&&(n.content=!0),e&&(n.move=!0,c.push(m)),h[0].push(n)}}o.attachedSignals?p.attachedSignals=o.attachedSignals:p.attachedSignals&&delete p.attachedSignals}if(m.boundary){const s=m.boundary;n.innerBoundaries.push(s),y&&s.reattach();const i=s.component;if(p.attachedSignals!==o.attachedSignals){const e=p.attachedSignals,t=o.attachedSignals;if(e)for(const n in e){const s=e[n];t&&s===t[n]||i.unlistenTo(n,s)}if(t)for(const n in t){const s=t[n];e&&e[n]===s||i.listenTo(n,s)}}if((p.attachedContexts||o.attachedContexts)&&I.handleAttachedContexts(p,o),!y){let n=0;const o=i.contextAPI,r=s.outerContexts;let a=null;for(const s in r){const i=r[s];g[s]===i||o&&void 0!==o.getContext(s,t.Parent|t.Overridden)||(n|=e.Otherwise,a||(a=[]),a.push(s),o&&(n|=I.helpUpdateContext(o,s,g[s]||null,i)))}for(const s in g){if(void 0!==r[s])continue;const i=g[s];r[s]===i||o&&void 0!==o.getContext(s,t.Parent|t.Overridden)||(n|=e.Otherwise,a||(a=[]),a.push(s),o&&(n|=I.helpUpdateContext(o,s,i,null)))}if(n&&a&&(s._outerContextsWere=r,s.outerContexts=Object.assign({},g),o&&T.shouldUpdateContextually(n))){const e=s._preUpdates;e?e.contextual=e.contextual?[...new Set([...e.contextual,...a])]:a:s._preUpdates={contextual:a}}}const a='Stream'===i.constructor.MIX_DOM_CLASS;let l=null;const d=s.closure.envelope;o.childDefs[0]&&(l=d?{appliedDef:Object.assign(Object.assign({},d.appliedDef),{childDefs:p.childDefs,action:p.action}),targetDef:Object.assign(Object.assign({},d.targetDef),{childDefs:o.childDefs})}:{appliedDef:{tag:null,MIX_DOM_DEF:'fragment',childDefs:p.childDefs,action:'mounted'},targetDef:{tag:null,MIX_DOM_DEF:'fragment',childDefs:o.childDefs}}),a&&(h=I.mergeChanges(h,i.reattachSource(!0)));const u=!d&&!l,f=u?null:s.closure.preRefresh(l,null,null!=s._nUpdates&&s._nUpdates>s.host.settings.maxCyclicalUpdates);a&&(s._nUpdates=(s._nUpdates||0)+1),h=I.mergeChanges(h,n.host.services.updateBoundary(s,r,c,f)),a&&delete s._nUpdates,u||(h=I.mergeChanges(h,s.closure.applyRefresh(r)))}if(p.attachedRefs||o.attachedRefs){const e=p.attachedRefs,t=o.attachedRefs;if(e)for(const n of e)t&&t.includes(n)||C.willDetachFrom(n,m);if(t)for(const n of t)e&&e.includes(n)||C.didAttachOn(n,m);p.attachedRefs=t}}return h},pairDefs(e,t,n,s,o,r,i){var a,l;const d=e.host.settings,c=d.noRenderValuesMode,u=d.wideKeysInArrays,h=[],f=e.boundaryId?e:e.sourceBoundary;let p,m=[[{childDefs:[t]},{childDefs:[n]},e.treeNode,Object.assign({},e.outerContexts),!1]],g=0;for(;p=m[g];){g++;const[e,t,n,d,y]=p;let D=t.scopeMap||p[5];if(D&&'spread-pass'===t.scopeType&&(D=void 0),e.childDefs[0]){const h=I.findAppliedChildDefs(t,e,D||s,o,f,u);t.childDefs=h;for(let n,s=0;n=e.childDefs[s];s++){let e=null;switch(n.MIX_DOM_DEF){case'content':e=c&&(!0===c?!n.domContent:-1!==c.indexOf(n.domContent));break;case'fragment':if(e=!1,void 0===n.withContent)break;const o=null==f?void 0:f.component;if('function'==typeof n.withContent){const r=n.withContent();o&&o.contentAPI.needsFor(r,'temp',!0);const i=t.childDefs[s],d=(null===(a=i.StreamOut)||void 0===a?void 0:a.closure)||null,c=r.closure||null;d!==c&&(d&&(null===(l=d.streamLinks)||void 0===l||l.delete(i)),c&&(c.streamLinks?c.streamLinks.add(i):c.streamLinks=new Set([i]))),i.StreamOut=r,e=!r.closure.hasContent()}else n.withContent&&(e=!f||!f.closure.hasContent()),o&&o.contentAPI.needs('temp',!0)}if(null!==e){const n=t.childDefs[s];e?n.disabled=!0:delete n.disabled}}const p=n&&'boundary'!==e.MIX_DOM_DEF&&('element'!==e.MIX_DOM_DEF||e.domElement)?I.assignTreeNodesForChildren(h,n,y,f,i):[],C=[];for(let t,n=0;t=e.childDefs[n];n++){const e=p[n]||null,s=h[n];!e&&s.treeNode&&(s.treeNode.sourceBoundary=null,r&&r.push(s));const o=[t,s,e,t.contexts&&'contexts'===t.MIX_DOM_DEF?I.mergeOuterContexts(d,t.contexts):d,'fragment'===t.MIX_DOM_DEF];C.push(o),D&&(o[5]=D)}m=C.concat(m.slice(g)),g=0}else t.childDefs=[];n&&e.MIX_DOM_DEF&&t.MIX_DOM_DEF&&h.push([e,t,n,d])}return h},findAppliedChildDefs(e,t,n,o,r,i){var l,d,c,u,h,f;let p=t.childDefs.length;if(!p)return[];const m=i||!t.isArray;if(!i&&t.isArray!=(e&&e.isArray))return t.childDefs.map((e=>a.newAppliedDefBy(e,r&&r.closure||null)));const g=e&&e.childDefs||null,y=[];for(let i=0;i<p;i++){const p=t.childDefs[i],D=null!=p.key,C=p.MIX_DOM_DEF,v=p.getContentStream||I.SEARCH_TAG_BY_TYPE[C]||p.tag;let b=!1,M=null;if(g)for(const e of g)if((D?e.key===p.key:null==e.key)&&v===(e.getContentStream||I.SEARCH_TAG_BY_TYPE[e.MIX_DOM_DEF]||e.tag)&&o.has(e)&&('boundary'!==C||!(null===(c=null===(d=null===(l=e.treeNode)||void 0===l?void 0:l.boundary)||void 0===d?void 0:d.component)||void 0===c?void 0:c.constantProps)||s.equalDictionariesBy(p.props,e.props,e.treeNode.boundary.component.constantProps))){M=e,o.delete(e);break}if(!M&&D&&m){const e=n&&n.get(v);if(e)for(const t of e)if(t.key===p.key&&o.has(t)&&('boundary'!==C||!(null===(f=null===(h=null===(u=t.treeNode)||void 0===u?void 0:u.boundary)||void 0===h?void 0:h.component)||void 0===f?void 0:f.constantProps)||s.equalDictionariesBy(p.props,t.props,t.treeNode.boundary.component.constantProps))){M=t,o.delete(t),b=!0;break}}M?M.action=b||!e||e.childDefs[i]!==M?'moved':'updated':M=a.newAppliedDefBy(p,r&&r.closure||null),y.push(M)}return y},assignTreeNodesForChildren(e,t,n,s,o){t.children[0]&&(t.children=[]);const r=e.length;if(!r)return[];const i=[];let a=0,l=null,d=t;if(n){if(!t.parent)return[];if(d=t.parent,l=t,a=d.children.indexOf(t),-1===a)return[]}for(let t=0;t<r;t++){const n=e[t];if(n.disabled){a--,i.push(null);continue}let r=null;n.treeNode?r=n.treeNode:'fragment'!==n.MIX_DOM_DEF&&(n.action='mounted'),l&&(r?d.children.splice(a,1):r=l,l=null);const c=n.MIX_DOM_DEF,u='content'===c||'element'===c?'dom':'fragment'===c?'':c;if(r){if(r.parent){const e=r.parent.children.indexOf(r);0===e&&r.parent!==d&&!0===M.PASSING_TYPES[r.parent.type]&&o&&-1===o.indexOf(r.parent)&&o.push(r.parent),-1!==e&&r.parent.children.splice(e,1)}r.parent=d,r.sourceBoundary=s||null,r.type=u}else r={type:u,parent:d,children:[],sourceBoundary:s||null,domNode:null},'dom'===r.type&&(r.domProps={});'fragment'!==n.MIX_DOM_DEF&&(r.def=n,n.treeNode=r),d.children.splice(a+t,0,r),i.push(r)}return i},assignTreeNodesForPass(e){const t=e._innerDef,n=e.sourceBoundary,s=[],o=[],r=[];let i,a=[[e.targetDef,t,e.treeNode,Object.assign({},e.outerContexts),!1]],l=0;for(;i=a[l];){l++;const[e,t,d,c,u]=i;if(t.childDefs[0]){const r=d&&'boundary'!==e.MIX_DOM_DEF&&('element'!==e.MIX_DOM_DEF||e.domElement)?I.assignTreeNodesForChildren(t.childDefs,d,u,n,o):[];let i=0;const h=[];for(const n of t.childDefs){const t=r[i]||null;!t&&n.treeNode&&(s.push(n.treeNode),n.treeNode.sourceBoundary=null);const o=e.childDefs[i],a=o.contexts&&'contexts'===o.MIX_DOM_DEF?I.mergeOuterContexts(c,o.contexts):c;h.push([o,n,t,a,'fragment'===n.MIX_DOM_DEF]),i++}a=h.concat(a.slice(l)),l=0}d&&!t.disabled&&r.push([e,t,d,c])}return[r,s,o]},buildDefMaps(e,t=!1,n=new Set,s){const o=new Map;let r,i=t?e.childDefs.slice():[e],a=0;for(;r=i[a];){a++,n.add(r);const e=r.getContentStream||I.SEARCH_TAG_BY_TYPE[r.MIX_DOM_DEF]||r.tag,t=o.get(e);if(t?t.push(r):o.set(e,[r]),r.scopeType)if('spread-pass'===r.scopeType)s&&s.push(r);else{const e=[];r.scopeMap=I.buildDefMaps(r,!0,n,e)[0],e[0]&&(i=e[0].childDefs.concat(i.slice(a)),a=0)}else r.childDefs[0]&&(i=r.childDefs.concat(i.slice(a)),a=0)}return[o,n]},cleanUpBoundaryDefs(e,t=!1,n=!0,s=!0){var o,r;t&&console.log('___Apply.cleanUpBoundaryDefs: Dev-log: Clean up unused defs: ',[...e]);let i=[[],[]];for(const t of e){const e=t.treeNode;if(e){switch(t.MIX_DOM_DEF){case'dom':case'element':case'content':s&&i[0].push({treeNode:e,remove:!0});break;case'boundary':e.boundary&&(i=I.mergeChanges(i,I.destroyBoundary(e.boundary,!1,s)));break;case'pass':t.contentPass&&(i=I.mergeChanges(i,t.contentPass.contentUngrounded(t)),t.getContentStream&&(null===(o=t.contentPass.streamLinks)||void 0===o||o.delete(t)));case'host':{const n=t.host;if(n&&n.groundedTree.parent===e){n.groundedTree.parent=null,e.children=[],i[0].push({treeNode:e,move:!0});const t=n.sourceHost;t&&(t.ghostHosts&&(t.ghostHosts.delete(n),t.ghostHosts.size||delete t.ghostHosts),delete n.sourceHost)}}case'contexts':if(t.contexts)for(const n in t.contexts){const s=t.contexts[n];if(!s)continue;s.onRemoveFrom&&s.onRemoveFrom(e,n);const o=s.inTree.get(e);o&&o.size>1?o.delete(n):s.inTree.delete(e)}case'fragment':t.StreamOut&&'function'==typeof t.withContent&&(null===(r=t.StreamOut.closure.streamLinks)||void 0===r||r.delete(t));default:if(t.attachedRefs&&t.MIX_DOM_DEF)for(const n of t.attachedRefs)C.willDetachFrom(n,e)}n&&(e.parent=null,e.sourceBoundary=null,delete t.treeNode)}}return i},destroyBoundary(e,t=!0,n=!0){let s=[[],[]];if(null===e.isMounted)return s;const o=e.boundaryId?e:null;if(o){const e=o.component,t=e.constructor;if(e.signals.willUnmount&&u(e.signals.willUnmount),o._outerDef.attachedRefs)for(const e of o._outerDef.attachedRefs)C.willDetachFrom(e,o.treeNode);if(e.hostListeners){for(const[t,n]of e.hostListeners)o.host.unlistenTo(t,n);delete e.hostListeners}if(e.hostDataListeners){for(const[t]of e.hostDataListeners)o.host.unlistenToData(t);delete e.hostDataListeners}const n=e.contextAPI;if(n){const e=n.getContexts();for(const t in e){const s=e[t];s&&I.helpUpdateContext(n,t,null,s)}}if(t.api&&(t.api.components.delete(e),t.api.signals&&(t.api.signals={})),'Stream'===t.MIX_DOM_CLASS&&(s=I.mergeChanges(s,t.removeSource(e))),e.contentAPI.streamNeeds){for(const t of[...e.contentAPI.streamNeeds.keys()])t.contentLinks.delete(e.contentAPI);e.contentAPI.streamNeeds.clear()}e.signals&&(e.signals={}),e.timers&&e.clearTimers()}return n&&(s[0]=s[0].concat(l.rootDOMTreeNodes(e.treeNode,!0).map((e=>({treeNode:e,remove:!0}))))),e._innerDef&&(s=I.mergeChanges(s,I.cleanUpBoundaryDefs(l.allDefsIn(e._innerDef),e.host.settings.devLogCleanUp,t,!1))),o&&o.host.services.cancelUpdates(o),e.isMounted=null,s},handleAttachedContexts(t,n){const s=n.attachedContexts;if(!t.treeNode||!s&&!t.attachedContexts)return;const o=t.treeNode,r='boundary'===o.type&&o.boundary||null,i=t.attachedContexts||{};t.attachedContexts=s;const a=r&&r.component.contextAPI;if(a){const t=a.overriddenContexts||{},n=s||{},o=new Set([...Object.keys(i),...Object.keys(n)]);let l=0,d=null;for(const s of o){if(void 0!==t[s])continue;const o=void 0===i[s]?r.outerContexts[s]:i[s],c=n[s];c!==o&&(l|=e.Otherwise,l|=I.helpUpdateContext(a,s,c,o),d||(d=[]),d.push(s))}if(d&&T.shouldUpdateContextually(l)){const e=r._preUpdates;e?e.contextual=e.contextual?[...new Set([...e.contextual,...d])]:d:r._preUpdates={contextual:d}}}},helpUpdateContext(t,n,s,o){let r=0;return[...t.dataListeners].some((([,[e]])=>e.some((e=>e===n||e.startsWith(n+'.')))))&&(o&&o.services.onDisInterest('data',t.component,n),s&&s.services.onInterest('data',t.component,n),r|=e.Data),t.signalsBy[n]&&(o&&o.services.onDisInterest('signals',t.component,n),s&&s.services.onInterest('signals',t.component,n),r|=e.Actions),r},mergeOuterContexts(e,t){const n=Object.assign({},e);for(const e in t){const s=t[e];s?n[e]=s:delete n[e]}return n},sortBoundaries(e){const t=new Map;for(const n of e){let e=n.boundaryId,s=n.parentBoundary;for(;s;)e=(s.boundaryId||'')+'>'+e,s=s.parentBoundary;const o=t.get(e);if(o){let e=0;if(n.parentBoundary){const t=n.parentBoundary.innerBoundaries,s=t.indexOf(n);for(const n of o){if(s<t.indexOf(n))break;e++}}o.splice(e,0,n)}else t.set(e,[n])}const n=[];for(const e of t.keys()){let t=0,s=!1;for(const o of n){if(o.startsWith(e+'>'))break;if(e.startsWith(o+'>'))s=!0;else if(s)break;t++}n.splice(t,0,e)}let s=0;for(const o of n)for(const n of t.get(o))e[s]=n,s++},mergeChanges(e,...t){let n=e;for(const e of t)e&&(n?(n[0]=n[0].concat(e[0]),n[1]=n[1].concat(e[1])):n=e);return n}};class E{constructor(e,t){this.thruBoundary=e||null,this.sourceBoundary=t||null,this.envelope=null,this.truePassDef=null,this.groundedDefsMap=new Map,this.pendingDefs=new Set,this.contentLinks=new Set}hasContent(){var e;const t=null===(e=this.envelope)||void 0===e?void 0:e.appliedDef;return!(!t||t.disabled||'fragment'===t.MIX_DOM_DEF&&(!t.childDefs.length||t.childDefs[0].disabled&&1===t.childDefs.length))}readContent(e=!1){if(!this.envelope)return null;const t=this.envelope.appliedDef,n=t.childDefs;if('fragment'===t.MIX_DOM_DEF&&(!n.length||n[0].disabled&&1===n.length))return null;const s=this.envelope.targetDef.childDefs;return e?s.slice():s}collectInterested(e){const t=new Set;if(e){if(this.streamLinks)for(const e of this.streamLinks){let n=null;switch(e.MIX_DOM_DEF){case'fragment':'function'==typeof e.withContent&&(n=e.withContent());break;case'pass':e.getContentStream&&(n=e.getContentStream())}if(n&&n.contentLinks.size)for(const e of n.contentLinks)t.add(e.component.boundary)}}else if(this.thruBoundary){let e,n=[this.thruBoundary],s=0;for(;e=n[s];){s++;for(const n of e.closure.contentLinks)t.add(n.component.boundary);e.innerBoundaries[0]&&(n=e.innerBoundaries.filter((e=>e.boundaryId&&e.closure.contentLinks.size)).concat(n.slice(s)),s=0)}}return t.size?t:null}contentGrounded(e,t,n,s){return this.groundedDefsMap.get(e)?'moved'===e.action&&n.boundary?[l.rootDOMTreeNodes(n.boundary.treeNode,!0,!0).map((e=>({treeNode:e,move:!0}))),[]]:[[],[]]:(this.groundedDefsMap.set(e,[t,n,s]),this.applyContentDefs([e]))}contentUngrounded(e){const t=this.groundedDefsMap.get(e);if(!t)return[[],[]];this.truePassDef===e&&(this.truePassDef=null),this.groundedDefsMap.delete(e),this.pendingDefs.delete(e);const n=t[1].boundary;return n?I.destroyBoundary(n):[[],[]]}preRefresh(e,t,n){var s;if(this.stream&&this.stream.canRefresh())return this.envelope=e,this.stream.preRefresh(e,n);if(!this.envelope&&!e)return null;const o=n?null:this.collectInterested(t);if(o){const e=(null===(s=this.envelope)||void 0===s?void 0:s.targetDef.childDefs.slice())||[];if(t)for(const n of o)n._preUpdates?n._preUpdates.streamed?n._preUpdates.streamed.has(t)||n._preUpdates.streamed.set(t,e):n._preUpdates.streamed=new Map([[t,e]]):n._preUpdates={streamed:new Map([[t,e]])};else for(const t of o)t._preUpdates?t._preUpdates.children||(t._preUpdates.children=e):t._preUpdates={children:e}}return this.envelope=e,this.pendingDefs=new Set(this.groundedDefsMap.keys()),o}applyRefresh(e=!1){if(this.stream&&this.stream.canRefresh())return this.stream.applyRefresh(e);let t=[],n=[];return this.pendingDefs.size&&([t,n]=this.applyContentDefs(this.pendingDefs,e)),[t,n]}applyEnvelope(e){const t=this.preRefresh(e),n=t?T.updateInterested(t):null,s=this.applyRefresh();return n?[n[0].concat(s[0]),n[1].concat(s[1])]:s}applyContentDefs(e,t=!1){e||(e=this.groundedDefsMap.keys());let n=[],s=[];for(const o of e){this.pendingDefs.delete(o);const e=this.groundedDefsMap.get(o);if(void 0===e)continue;let[r,i,a]=e,l=i.boundary;if(this.envelope&&this.sourceBoundary){let e=!0;const d=this.envelope;l?(e=this.truePassDef===o,l.updateEnvelope(d.targetDef,e?d.appliedDef:null)):(l=new te(o,d.targetDef,i,this.sourceBoundary),e=null==a&&(!this.truePassDef||this.truePassDef===o),e&&(l._innerDef.childDefs=d.appliedDef.childDefs,this.truePassDef=o),l.parentBoundary=r,i.boundary=l);const[c,u]=e?I.runContentPassUpdate(l,t):I.runBoundaryUpdate(l,t);n=n.concat(c),s=s.concat(u)}else if(l){const e=I.destroyBoundary(l,!1);n=n.concat(e[0]),s=s.concat(e[1]),i.boundary=null}}return[n,s]}}class B{constructor(e){this.component=e}read(e=!1){var t;const n=(null===(t=this.component.boundary.closure.envelope)||void 0===t?void 0:t.targetDef.childDefs)||null;return e&&n?n.slice():n}get(e=!1,t=!1){return e||this.needs('temp',!0),this.read(t)}needs(e,t=!1){if(t&&'boolean'==typeof this.localNeeds)return;this.localNeeds=null!=e?e:null;const n=this.component.boundary.closure.contentLinks;null==e?n.delete(this):n.add(this)}readFor(e,t=!1){return e.closure?e.closure.readContent(t):null}getFor(e,t=!1,n=!1){return e.isStream()?(t||this.needsFor(e,'temp',!0),this.readFor(e,n)):null}needsFor(e,t,n=!1){e.isStream()&&(n&&this.streamNeeds&&'boolean'==typeof this.streamNeeds.get(e)||(null==t?(this.streamNeeds&&this.streamNeeds.delete(e),e.contentLinks.delete(this)):(this.streamNeeds?this.streamNeeds.set(e,t):this.streamNeeds=new Map([[e,t]]),e.contentLinks.add(this))))}}function L(e){return class extends e{constructor(e,...t){super(...t),this.dataListeners=new Map,this.dataKeysPending=null,this.data=e}listenToData(...e){let t=1;const n=e.length,s='boolean'==typeof e[n-t]&&e[n-t++],o=e[n-t],r=e.slice(0,n-t);this.dataListeners.set(o,r),s&&o(...r.map((e=>this.getInData(e))))}unlistenToData(e){return!!this.dataListeners.has(e)&&(this.dataListeners.delete(e),!0)}getData(){return this.data}getInData(e,t){if(!this.data)return t;if(!e)return this.data;const n=e.split('.');let s=this.data;for(const e of n){if(!s)return t;s=s[e]}return void 0===s?t:s}setData(e,t=!1,n=!0,...s){this.data=t&&this.data?Object.assign(Object.assign({},this.data),e):e,n?this.refreshData(!0,...s):this.addRefreshKeys(!0)}setInData(e,t,n=!1,s=!0,...o){if(this.data){if(e){const s=e.split('.'),o=s.pop();if(!o)return;let r=this.data;for(const e of s)r=r[e]||(r[e]={});if(n){const e=r[o];e&&e.constructor===Object?r[o]=Object.assign(Object.assign({},e),t):n=!1}n||(r[o]=t)}else this.data=n&&this.data?Object.assign(Object.assign({},this.data),t):t;s?this.refreshData(e||!0,...o):this.addRefreshKeys(e||!0)}}refreshData(e,t){if(e&&this.addRefreshKeys(e),null!=t)return void setTimeout((()=>this.refreshData(null)),t);const n=this.dataKeysPending;if(this.dataKeysPending=null,n)for(const[e,t]of this.dataListeners.entries())(!0===n||n.some((e=>t.some((t=>t===e||t.startsWith(e+'.')||e.startsWith(t+'.'))))))&&e(...t.map((e=>this.getInData(e))))}addRefreshKeys(e){if(!0===e)this.dataKeysPending=!0;else if(e&&!0!==this.dataKeysPending)if('string'==typeof e&&(e=[e]),this.dataKeysPending)for(const t of e)this.dataKeysPending.some((e=>e===t||t.startsWith(e+'.')))||this.dataKeysPending.push(t);else this.dataKeysPending=[...e]}}}const R=L;class A extends(L(Object)){}function U(e){return class extends(L(m(e))){}}const k=U;class j extends(U(Object)){}class F{constructor(e){this.context=e,this.refreshTimer=null,this.dirtyOrder=0}getListeners(t,n){let s=[];const o=this.context;let r=o.signalComponents;this.dirtyOrder&e.Actions&&(r.size>1&&(o.signalComponents=r=F.sortCollection(r)),this.dirtyOrder&=~e.Actions);for(const[e,o]of r){const r=e.contextAPI;if(r)for(const e of o){const o=r.signalsBy[e];o&&o[t]&&(n?s.push([r,e]):s.push(o[t]))}}return this.context.signals[t]&&s.push(this.context.signals[t]),s[0]?s:null}afterSignalRefresh(e,t=!1,n){return new Promise((s=>{const o=this.context,r=t?'_afterDelay':'_afterPreDelay';this[r]||(this[r]=[]),this[r].push((t=>{const n=this.getListeners(e,!0);let r=[];if(n)for(const[s,o]of n){const n=s.signalsBy[o];n&&n[e]&&(r.push(n[e]),t&&t.add(s.component.boundary.host))}o.signals[e]&&r.push(o.signals[e]),s(r[0]?r:null)})),this.triggerRefresh(o.settings.refreshTimeout,n)}))}triggerRefresh(e,t){this.refreshTimer=s.refreshWithTimeout(this,this.refreshPending,this.refreshTimer,e,t)}refreshPending(){const e=this.context.dataKeysPending;let t=this._afterPreDelay,n=this._afterDelay;this.refreshTimer=null,this.context.dataKeysPending=null,delete this._afterPreDelay,delete this._afterDelay;const s=n?new Set:null;if(t)for(const e of t)e(s);if(e&&this.runData(e,s),n&&s){for(const e of[...s])e.services.hasPending()?e.listenTo('onRender',this.onHostRender.bind(this,e),null,d.OneShot):s.delete(e);this._afterDelayPending||(this._afterDelayPending=[]),this._afterDelayPending.push([s,n]),s.size||this.onHostRender()}}runData(t,n){const s=this.context;let o=s.dataComponents;this.dirtyOrder&e.Data&&o.size>1&&(s.dataComponents=o=F.sortCollection(o)),this.dirtyOrder&=~e.Data;for(const[e,s]of o){const o=e.boundary.host;n&&n.add(o);const r=e.contextAPI;if(r)for(const e of s)for(const[n,[s,o]]of r.dataListeners.entries()){(!0===t||t.some((t=>{const n=e+'.'+t;return s.some((e=>e===n||e.startsWith(n+'.')||n.startsWith(e+'.')))})))&&n(...r.buildDataArgsBy(s,o))}}if(s.dataListeners.size)for(const[e,n]of s.dataListeners)(!0===t||t.some((e=>n.some((t=>t===e||t.startsWith(e+'.')||e.startsWith(t+'.'))))))&&e(...n.map(((e,t)=>s.getInData(e))))}onInterest(t,n,s){const o=this.context,r='data'===t,i=r?o.dataComponents:o.signalComponents,a=i.get(n);a?a.add(s):i.set(n,new Set([s])),this.dirtyOrder|=r?e.Data:e.Actions;const l=r?'onDataInterests':'onSignalInterests';o[l]&&o[l](n,s,!0)}onDisInterest(e,t,n){const s=this.context,o='data'===e,r=o?'onDataInterests':'onSignalInterests';s[r]&&s[r](t,n,!1);const i=o?s.dataComponents:s.signalComponents,a=i.get(t);a&&(a.delete(n),a.size||i.delete(t))}onHostRender(e=null){const t=this._afterDelayPending;if(!t)return;let n=-1;for(const[s,o]of[...t])if(n++,e&&s.delete(e),!s.size){t.splice(n--,1);for(const e of o)e(null)}t[0]||delete this._afterDelayPending}onComponentMove(t,n){const s=t.contextAPI;s&&(this.dirtyOrder|=(s.signalsBy[n]&&e.Actions||0)|([...s.dataListeners.values()].some((([e])=>e.some((e=>e===n||e.startsWith(n+'.')))))&&e.Data||0))}static sortCollection(e){const t=[...e.keys()].map((e=>e.boundary));return I.sortBoundaries(t),new Map(t.map((t=>[t.component,e.get(t.component)])))}}var X=(e,t,n,s)=>new(n||(n=Promise))(((o,r)=>{function i(e){try{l(s.next(e))}catch(e){r(e)}}function a(e){try{l(s.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((e=>{e(t)}))).then(i,a)}l((s=s.apply(e,t||[])).next())}));class W extends j{constructor(e,t){super(e),this.dataComponents=new Map,this.signalComponents=new Map,this.inTree=new Map,this.settings=W.getDefaultSettings(),this.services=new F(this),t&&this.modifySettings(t)}sendSignal(e,...t){const n=this.services.getListeners(e);if(n)for(const e of n)u(e,t)}sendSignalAs(e,t,...n){const s='string'==typeof e?[e]:e,o=s.includes('delay')||s.includes('pre-delay'),r=s.includes('first')||s.includes('first-true');if(s.includes('await'))return new Promise((e=>X(this,void 0,void 0,(function*(){const i=o?yield this.services.afterSignalRefresh(t,s.includes('delay')):this.services.getListeners(t);if(!i)return s.includes('last')||r?e(void 0):e([]);let a=(yield Promise.all(f(i,n))).filter((e=>!(void 0===e||null==e&&s.includes('no-null')||!e&&s.includes('no-false'))));s.includes('last')?e(a[-1]):r?(s.includes('first-true')&&(a=a.filter((e=>e))),e(a[0])):e(a)}))));if(!o){const e=this.services.getListeners(t);return e?f(e,n,s):s.includes('last')||r?void 0:[]}(()=>{X(this,void 0,void 0,(function*(){const e=yield this.services.afterSignalRefresh(t,s.includes('delay'));if(e)if(r)f(e,n,s);else for(const t of e)u(t,n)}))})()}afterRefresh(e=!1,t){return new Promise((n=>X(this,void 0,void 0,(function*(){const s=e?'_afterDelay':'_afterPreDelay';this.services[s]||(this.services[s]=[]),this[s].push((()=>n())),this.services.triggerRefresh(this.settings.refreshTimeout,t)}))))}refreshData(e,t){e&&this.addRefreshKeys(e),this.services.triggerRefresh(this.settings.refreshTimeout,t)}modifySettings(e){const t=W.getDefaultSettings();for(const n in e)e[n]=void 0===e[n]?t[n]:e[n]}static getDefaultSettings(){return{refreshTimeout:0}}}W.MIX_DOM_CLASS='Context';const H=(e,t)=>new W(e,t),K=(e,t)=>{const n={};for(const s in e)n[s]=H(e[s],t);return n};class z{constructor(e){this.component=e,this.dataListeners=new Map,this.signalsBy={}}listenTo(e,t,n,s,o){var r;const[i,a]=e.split('.',2),l=this.signalsBy[i],c=[t,n||null,s||d.None];if(null!=o&&c.push(o),l){let e=l[a];e?e.some(((n,s)=>n[0]===t&&(e[s]=c)))||e.push(c):l[a]=e=[c]}else this.signalsBy[i]={[a]:[c]};null===(r=this.getContext(i))||void 0===r||r.services.onInterest('signals',this.component,i)}unlistenTo(e,t,n){var s;for(const o of e?'string'==typeof e?[e]:e:Object.keys(this.signalsBy)){const[e,r]=o.split('.',2),i=this.signalsBy[e];if(!i)return;const a=r?[r]:Object.keys(i),l=null!=n;let d=!0;for(const e of a){const s=i[e];if(s){for(let e=s.length-1;e>=0;e--)t&&t!==s[e][0]||l&&n!==s[e][3]||s.splice(e,1);s[0]?d=!1:delete i[e]}}d&&!Object.keys(i).length&&(null===(s=this.getContext(e))||void 0===s||s.services.onDisInterest('signals',this.component,e))}}isListening(e,t,n){if(!e)return Object.keys(this.signalsBy).some((e=>this.isListening(e,t,n)));const[s,o]=e.split('.',2),r=this.signalsBy[s];if(!r)return!1;const i=o?r[o]:Object.values(r).reduce(((e,t)=>e.concat(t)),[]);return!!i[0]&&(!(t&&!i.some((e=>e[0]===t)))&&!(null!=n&&!i.some((e=>e[3]===n))))}sendSignal(e,...t){var n;const[s,o]=e.split('.',2);return null===(n=this.getContext(s))||void 0===n?void 0:n.sendSignal(o,...t)}sendSignalAs(e,t,...n){const[s,o]=t.split('.',2),r=this.getContext(s);return r?r.sendSignalAs(e,o,...n):void 0}listenToData(...e){let t=1;const n=e.length,s='boolean'==typeof e[n-t]&&e[n-t++],o=Array.isArray(e[n-t])&&e[n-t++]||void 0,r=e[n-t],i=e.slice(0,n-t),a={},l=[...this.dataListeners.values()],d=this.dataListeners.get(r);this.dataListeners.set(r,[i,o]);for(const e of i){const t=e.split('.',1)[0];if(void 0!==a[t])continue;const n=a[t]=this.getContext(t)||null;n&&(l.some((([e])=>e.some((e=>e.startsWith(t)))))||n.services.onInterest('data',this.component,t))}if(d)for(const e of d[0]){const t=e.split('.',1)[0];if(void 0!==a[t])continue;const n=a[t]=this.getContext(t)||null;n&&(l.some((([e])=>e.some((e=>e===t||e.startsWith(t+'.')))))||n.services.onDisInterest('data',this.component,t))}s&&r(...this.buildDataArgsBy(i,o))}unlistenToData(e){const t=this.dataListeners.get(e);if(this.dataListeners.delete(e),!t)return!1;const n=[...this.dataListeners.values()];for(const e of t[0]){const t=e.split('.',1)[0],s=this.getContext(t)||null;s&&(n.some((([e])=>e.some((e=>e===t||e.startsWith(t+'.')))))||s.services.onDisInterest('data',this.component,t))}return!0}getInData(e,t){const n=e.split('.',1)[0],s=this.getContext(n);return s?s.getInData(e.slice(n.length+1),t):t}setInData(e,t,n,s,o){var r;const i=e.split('.',1)[0];null===(r=this.getContext(i))||void 0===r||r.setInData(e.slice(i.length+1),t,n,s,o)}refreshData(e,t){var n,s;const o={};for(const t of'string'==typeof e?[e]:e){const e=t.split('.',1)[0];void 0!==o[e]&&(o[e]=this.getContext(e)),null===(n=o[e])||void 0===n||n.addRefreshKeys(t.slice(e.length+1))}for(const e in o)null===(s=o[e])||void 0===s||s.refreshData(null,t)}refreshDataBy(e,t){const n=this.getContexts(e);for(const s in n){const o=n[s];o&&o.refreshData(e[s],t)}}hasContext(e,n=t.All){return!!this.getContext(e,n)}getContext(e,n=t.All){if(n&t.Overridden){const t=this.overriddenContexts;if(t&&void 0!==t[e])return t[e]}const s=this.component.boundary;if(n&t.Parent){const t=s._outerDef.attachedContexts;if(t&&void 0!==t[e])return t[e]}if(n&t.Cascading)return s.outerContexts[e]}getContexts(e,n=t.All){const o=e?s.buildRecordable(e):null,r={},i=this.component.boundary;if(n&t.Cascading)for(const e in i.outerContexts)o&&!o[e]||(r[e]=i.outerContexts[e]);if(n&t.Parent){const e=i._outerDef.attachedContexts;if(e)for(const t in e)o&&!o[t]||(r[t]=e[t])}if(n&t.Overridden){const e=this.overriddenContexts;if(e)for(const t in e)o&&!o[t]||(r[t]=e[t])}return r}newContext(e,t,n=!0){const s=H(e);return t&&this.overrideContext(t,s,n),s}newContexts(e,t=!1,n=!0){const s=K(e);return t&&this.overrideContexts(s,n),s}overrideContext(n,s,o=!0){const r=this.getContext(n),i=void 0!==s?s:this.getContext(n,t.Parent|t.Cascading);let a=this.overriddenContexts;void 0===s?a&&(delete a[n],Object.keys(a).length||delete this.overriddenContexts):(a||(a=this.overriddenContexts={}),a[n]=s);const l=r!==i?I.helpUpdateContext(this,n,i||null,r||null):e.None;return o&&T.shouldUpdateContextually(l)&&this.askDataBuildBy([n],'immediate'===o),l}overrideContexts(t,n=!0){let s=e.None;for(const e in t)s|=this.overrideContext(e,t[e],!1);return n&&T.shouldUpdateContextually(s)&&this.askDataBuildBy(Object.keys(t),'immediate'===n),s}askDataBuildBy(e=!0,t,n,s,o){if(null!==this.component.boundary.isMounted)if(t)for(const[t,[n,s]]of this.dataListeners.entries())(!0===e||e.some((e=>n.some((t=>t===e||t.startsWith(e+'.'))))))&&t(...this.buildDataArgsBy(n,s));else this.component.boundary.updateBy({contextual:!0===e?Object.keys(this.getContexts()):e},n,s,o)}buildDataArgsBy(e,t){const n=this.component.boundary,s=this.overriddenContexts,o=n._outerDef.attachedContexts,r=n.outerContexts,i=[];let a=0;for(const n of e){const e=n.split('.',1)[0];let l=s?s[e]:void 0;o&&void 0===l&&(l=o[e]),void 0===l&&(l=r[e]),i.push(l?l.getInData(n.slice(e.length+1),t&&t[a]):t&&t[a]),a++}return i}}class q extends y{constructor(){super(),this.components=new Set}update(e=!0,t,n){for(const s of this.components)s.triggerUpdate(e,t,n)}onListener(e,t,n){if(this.components.size){const s=this.signals[e][t],o=s[0];if(n)for(const t of this.components)t.listenTo(e,((...e)=>s[1]?o(t,...e,...s[1]):o(t,...e)),null,s[2],o);else for(const t of this.components)t.unlistenTo(e,o)}}}class G extends q{constructor(){super(),this.updateModes={props:'never'},this.builtProps=null}buildProps(){return this.onBuildProps?this.onBuildProps(this.builtProps):this.builtProps}getMixedProps(e){return this.onMixProps?this.onMixProps(e.props,this.builtProps,e):Object.assign(Object.assign({},e.props),e.state)}setProps(e,t,n,s){(this.builtProps!==e||t||void 0!==n||void 0!==s)&&(this.builtProps=e,this.update('trigger'!==t&&t,n,s))}refresh(e,t,n){this.setProps(this.buildProps(),e,t,n)}update(e=!0,t,n){for(const s of this.components)s.setState(this.getMixedProps(s),!1,e,t,n)}}function Y(...e){const t=e.length,n='string'==typeof e[t-1]?-1:0,s=e[t-3+n],o=e[t-2+n]||null,r=e[t-1+n],i=n?e[t-1]:r.name,l={[i]:(e,t)=>a.newDef(r,Object.assign({},t.state),he)}[i];return l.api=new G,s&&('object'==typeof s?l.api.builtProps=s:t>2&&'function'==typeof s&&(l.api.onBuildProps=s)),o&&(l.api.onMixProps=o),l}function V(e){var t;return(t=class extends(m(e)){constructor(e,t,...n){super(...n),this.contentAPI=new B(this),this.props=e,t&&(this.boundary=t,t.component=this,t._initContextAPI&&this.initContextAPI())}initContextAPI(){this.contextAPI||(this.contextAPI=new z(this))}getHost(){return this.boundary.host}listenToHost(e,t,n,s){if(this.hostListeners){const n=this.hostListeners;n.some((([n,s],o)=>n===e&&s===t))||n.push([e,t])}else this.hostListeners=[[e,t]];this.boundary.host.listenTo(e,t,n,s)}unlistenToHost(e,t){if(this.boundary.host.unlistenTo(e,t),this.hostListeners){'string'==typeof e&&(e=[e]);for(let n=this.hostListeners.length-1;n>=0;n--){const[s,o]=this.hostListeners[n];e&&!e.includes(s)||t&&t!=o||this.hostListeners.splice(n,1)}}}isListeningToHost(e,t){return this.hostListeners&&this.hostListeners.some((([n,s])=>!(e&&n!==e||t&&s!==t)))||!1}listenToHostData(...e){let t=1;const n=e.length,s='boolean'==typeof e[n-t]&&e[n-t++],o=e[n-t],r=e.slice(0,n-t);this.hostDataListeners||(this.hostDataListeners=new Map),this.hostDataListeners.set(o,r),s&&o(...r.map(((e,t)=>this.boundary.host.getInData(e))))}unlistenToHostData(e){return!(!this.hostDataListeners||!this.hostDataListeners.has(e))&&(this.hostDataListeners.delete(e),this.hostDataListeners.size||delete this.hostDataListeners,!0)}afterRefresh(e=!1,t,n){return this.boundary.host.afterRefresh(e,t,n)}isMounted(){return!0===this.boundary.isMounted}queryElement(e,t=!1,n=!1){return l.domElementByQuery(this.boundary.treeNode,e,t,n)}queryElements(e,t=0,n=!1,s=!1){return l.domElementsByQuery(this.boundary.treeNode,e,t,n,s)}findElements(e=0,t=!1,n=!1,s){return l.treeNodesWithin(this.boundary.treeNode,{dom:!0},e,t,n,s).map((e=>e.domNode))}findComponents(e=0,t=!1,n=!1,s){return l.treeNodesWithin(this.boundary.treeNode,{boundary:!0},e,t,n,s).map((e=>e.boundary&&e.boundary.component))}findTreeNodes(e,t=0,n=!1,o=!1,r){return l.treeNodesWithin(this.boundary.treeNode,e&&s.buildRecordable(e),t,n,o,r)}newTimer(e,t){const n={};return this.setTimer(n,e,t),n}setTimer(e,t,n){this.timers?this.timers.has(e)&&this.clearTimer(e):this.timers=new Map,this.timers.set(e,setTimeout((()=>{this.clearTimer(e),t.call(this)}),n))}hasTimer(e){return!!this.timers&&this.timers.has(e)}clearTimer(e){if(!this.timers)return;const t=this.timers.get(e);null!=t&&(clearTimeout(t),this.timers.delete(e))}clearTimers(e){if(this.timers)if(e)for(const t of e)this.clearTimer(t);else this.timers.forEach((e=>clearTimeout(e))),this.timers.clear()}setUpdateModes(e,t=!0){t||(this.updateModes={});for(const t in e)this.updateModes[t]=e[t]}setConstantProps(e,t=!0,n=null){t&&this.constantProps||(this.constantProps={});let s=!1;if(e)if(Array.isArray(e))for(const t of e)this.constantProps[t]=null==n||n,s=!0;else for(const t in e)this.constantProps[t]=null!=n?n:e[t],s=!0;s||t||delete this.constantProps}setState(e,t=!0,n,s,o){const r=t?Object.assign(Object.assign({},this.state),e):e;this.boundary.updateBy({state:r},n,s,o)}setInState(e,t,n,s,o){const r=Object.assign(Object.assign({},this.state||{}),{[e]:t});this.boundary.updateBy({state:r},n,s,o)}triggerUpdate(e,t,n){this.boundary.host.services.absorbUpdates(this.boundary,{force:e||!1},!0,t,n)}createWrapper(...e){const t=Y(...e);return this.wrappers?this.wrappers.add(t):this.wrappers=new Set([t]),t}render(e,t){return null}}).MIX_DOM_CLASS='Component',t}const Q=V;class Z extends(V(Object)){constructor(e,t,...n){super(e,t,...n)}}function $(e,t=e.name){return{[t]:e.length>1?(t,n,s)=>e(n,s):(t,n)=>e(n)}[t]}const J=(e,t=e.name)=>({[t]:(t,n,s)=>e(n,s)}[t]);class ee{constructor(e,t,n){this.host=e,this.treeNode=n,this._outerDef=t,this._innerDef=null,this.isMounted=!1,this.sourceBoundary=null,this.parentBoundary=null,this.innerBoundaries=[],this.outerContexts={}}}class te extends ee{constructor(e,t,n,s){super(s.host,e,n),this.sourceBoundary=s,this.targetDef=t,this._innerDef=a.newAppliedDefBy(t,s.closure)}updateEnvelope(e,t){this.targetDef=e,t&&(this._innerDef.childDefs=t.childDefs)}}class ne extends ee{constructor(e,t,n,s){super(e,t,n),this._notRendered=!0,this.boundaryId=e.services.createBoundaryId(),this.sourceBoundary=s||null,this.closure=new E(this,s)}reattach(){this.component=null;const e=this._outerDef.props||{};let t=this._outerDef.tag;if('function'==typeof t){const n=t.api,s=t.MIX_DOM_CLASS?null:this._outerDef.tag,o=s&&s.length>=3||!1;o&&(this._initContextAPI=!0);const r=this.component=new(s?n?{[s.name]:class extends Z{}}[s.name]:Z:t)(e,this);if(this.component=r,this._initContextAPI&&(r.contextAPI||(r.contextAPI=new z(r)),delete this._initContextAPI),s&&(r.render=e=>s.apply(r,o?[e,r,r.contextAPI]:[e,r])),r.boundary||(r.boundary=this),n){r.constructor.api=n,n.components.add(r);for(const e in n.signals)for(const t of n.signals[e]){const[n,s,o]=t;r.listenTo(e,((...e)=>s?n(r,...e,...s):n(r,...e)),null,o,n)}}'Stream'===t.MIX_DOM_CLASS&&(this.closure.stream=r,t.addSource(r)),r.signals.preMount&&u(r.signals.preMount)}else this.component=new Z(e,this)}update(e,t,n){this.host.services.absorbUpdates(this,{force:this.isMounted?e||!1:'all'},!0,t,n)}updateBy(e,t,n,s){this.host.services.absorbUpdates(this,Object.assign(Object.assign({},e),{force:this.isMounted?t||!1:'all'}),!0,n,s)}render(e=0){e||(this._renderState='active');const t=this.component.contentAPI;if('temp'===t.localNeeds&&t.needs(null),t.streamNeeds)for(const[e,n]of t.streamNeeds)'temp'===n&&t.needsFor(e,null);const n=this._outerDef.props||{},s=this.component,o=s.render(n,s.state),r=this._notRendered;if(r&&delete this._notRendered,'function'==typeof o)return s.render=o,s.contextAPI&&r&&s.contextAPI.dataListeners.size&&s.contextAPI.askDataBuildBy(!0,!0),this.render(e);if('re-updated'===this._renderState){const t=this.host.settings;if(t.maxReRenders<0||e<t.maxReRenders)return e++,this._renderState='active',this.render(e);t.devLogWarnings&&console.warn('__SourceBoundary.render: Warning: The component tried to render for over '+(e+1).toString()+' times.',this._outerDef.tag.MIX_DOM_CLASS?s.constructor:this._outerDef.tag,s)}return delete this._renderState,o}}var se=(e,t)=>{var n={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&'function'==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(n[s[o]]=e[s[o]])}return n};class oe extends j{constructor(e,t,n,s){super(n),this.constructor.idCount++,this.groundedTree={type:'root',parent:null,children:[],domNode:t||null,sourceBoundary:null},this.settings=oe.getDefaultSettings(s),this.services=new T(this);const o=this.services.createRoot(e),r=a.newAppliedDefBy({MIX_DOM_DEF:'boundary',tag:o,props:{},childDefs:[]},null),i={type:'boundary',def:r,sourceBoundary:null,boundary:null,parent:this.groundedTree,children:[],domNode:null};this.groundedTree.children.push(i),this.rootBoundary=new ne(this,r,i),i.boundary=this.rootBoundary,this.rootBoundary.reattach(),this.services.absorbUpdates(this.rootBoundary,{})}clearRoot(e=!0,t,n){this.services.clearRoot(!0),e&&this.rootBoundary.update(!0,t,n)}moveRoot(e,t){if(this.groundedTree.domNode===e)return;this.groundedTree.domNode=e;const n=l.rootDOMTreeNodes(this.rootBoundary.treeNode,!0).map((e=>({treeNode:e,move:!0})));(n[0]||void 0!==t)&&this.services.absorbChanges(n,null,t)}updateRoot(e,t,n){this.services.updateRoot(e,t,n)}refreshRoot(e=!1,t,n){this.services.refreshRoot(e,t,n)}refreshDOM(e=!1,t){const n=!e||'read',s=[];let o,r=[...this.groundedTree.children],i=0;for(;o=r[i];)i+=1,o.domProps&&s.push({treeNode:o,refresh:n}),o.children[0]&&(r=o.children.concat(r.slice(i)),i=0);this.services.absorbChanges(s,null,t)}afterRefresh(e=!1,t,n){return new Promise((s=>{this.services.hasPending(!0,e,!0)?(this.listenTo(e?'onRender':'onUpdate',s),this.services.triggerUpdates(t,n)):s()}))}triggerRefresh(e,t){this.services.triggerUpdates(e,t)}setData(e,t=!1,n=!0,s,o){super.setData(e,t,n,s,o)}setInData(e,t,n=!1,s=!0,o,r){super.setInData(e,t,n,s,o,r)}refreshData(e,t,n){e&&this.addRefreshKeys(e),this.services.triggerUpdates(t,n)}pause(){this.services.renderer.pause()}resume(){this.services.renderer.resume()}isPaused(){return this.services.renderer.paused}rehydrate(e=null,t=!1,n=!1,s=!1,o,r){this.services.renderer.rehydrate(e||this.groundedTree.domNode,t,n,s,o,r)}rehydrateWith(e,t=null,n=!1,s=!1,o=!1,r,i){this.pause(),this.updateRoot(e,null,null),this.services.renderer.rehydrate(t||this.groundedTree.domNode,n,s,o,r,i)}readAsString(){return M.readAsString(this.rootBoundary.treeNode)}getRootElement(){return this.rootBoundary&&this.rootBoundary.treeNode.domNode}getRootElements(e){return this.rootBoundary?l.rootDOMTreeNodes(this.rootBoundary.treeNode,e,!1).map((e=>e.domNode)):[]}queryElement(e,t=!1){return l.domElementByQuery(this.groundedTree,e,!0,t)}queryElements(e,t=0,n=!1){return l.domElementsByQuery(this.groundedTree,e,t,!0,n)}findElements(e=0,t=!1,n){return l.treeNodesWithin(this.groundedTree,{dom:!0},e,!0,t,n).map((e=>e.domNode))}findComponents(e=0,t=!1,n){return l.treeNodesWithin(this.groundedTree,{boundary:!0},e,!0,t,n).map((e=>e.boundary&&e.boundary.component))}findTreeNodes(e,t=0,n=!1,o){return l.treeNodesWithin(this.groundedTree,e&&s.buildRecordable(e),t,!0,n,o)}modifySettings(e,t=!0){const n=this.settings.onlyRunInContainer,s=this.settings.welcomeContextsUpRoot;if(oe.modifySettings(this.settings,e),void 0!==s&&s!==e.welcomeContextsUpRoot){const e=this.groundedTree.parent&&this.groundedTree.parent.sourceBoundary&&this.groundedTree.parent.sourceBoundary.host,t=e&&this.settings.welcomeContextsUpRoot?e.rootBoundary.outerContexts:{};this.services.onContextPass(t)}if(void 0!==e.onlyRunInContainer&&e.onlyRunInContainer!==n&&this.refreshRoot(!1,null,null),t&&this.ghostHosts)for(const t of this.ghostHosts)t.modifySettings(e)}static modifySettings(e,t){const n=oe.getDefaultSettings(),{updateComponentModes:s}=t,o=se(t,['updateComponentModes']);if(s)for(const t in s){const o=s[t];e.updateComponentModes[t]='string'==typeof o?o:n.updateComponentModes[t]}for(const s in o){const o=t[s],r=typeof o;void 0===o?e[s]=n[s]:null!==o&&'boolean'!==r&&'string'!==r&&'number'!==r||(e[s]=o)}}static getDefaultSettings(e){const t={updateTimeout:0,renderTimeout:0,useImmediateCalls:!1,shouldUpdateWithNothing:!1,maxCyclicalUpdates:0,updateComponentModes:{props:'shallow',state:'shallow',children:'always',streamed:'always'},preCompareDOMProps:'if-needed',welcomeContextsUpRoot:!0,wideKeysInArrays:!1,noRenderValuesMode:!1,onlyRunInContainer:!1,disableRendering:!1,duplicateDOMNodeBehaviour:'deep',duplicateDOMNodeHandler:null,duplicatableHost:!1,maxReRenders:1,renderTextTag:'',renderHTMLDefTag:'span',renderTextHandler:null,renderSVGNamespaceURI:'http://www.w3.org/2000/svg',renderDOMPropsOnSwap:!0,devLogWarnings:!1,devLogRenderInfos:!1,devLogCleanUp:!1};if(e)for(const n in e)t[n]=e[n];return t}}oe.MIX_DOM_CLASS='Host',oe.idCount=0;function re(...e){const t=e.length,n=!0===e[t-1],s=n||!e[t-1]?e.slice(0,t-1):e,o=(e,t,o)=>{let r=null;for(const n of s){if(!n)continue;const s=t.state,i=n(e,t,o);'function'!=typeof i&&'function'==typeof r||(r=i),s!==t.state&&t.state&&(t.state=Object.assign(Object.assign({},s||{}),t.state))}return n?()=>r:r};let r=!1;const i=s.filter((e=>(r=r||e.length>2,e.api))).map((e=>e.api)),a=r?(e,t,n)=>o(e,t,n):(e,t)=>o(e,t);return i[0]&&(a.api=function(e){const t=e.some((e=>e instanceof G))?new G:new q;for(const n of e){if(n.updateModes){t.updateModes||(t.updateModes={});for(const e in n.updateModes)t.updateModes[e]=Object.assign(Object.assign({},t.updateModes[e]||{}),n.updateModes[e])}for(const e in n.signals)t.signals[e]=[...t.signals[e]||[],...n.signals[e]];n instanceof G&&(n.builtProps&&(t.builtProps=n.builtProps),n.onBuildProps&&(t.onBuildProps=n.onBuildProps),n.onMixProps&&(t.onMixProps=n.onMixProps))}return t}(i)),a}function ie(...e){const t=e[0].MIX_DOM_CLASS?e[0]:null;let n=t||Z;for(const s of t?e.slice(1):e)n=s(n);return n}function ae(e,...t){const n='function'!=typeof t[t.length-1]&&!!t.pop(),s=t.length>1?re(...t):t[0];return{[e.name]:class extends e{render(e){const t=s(e,this,this.contextAPI);return n?super.render:'function'==typeof t?t:()=>t}}}[e.name]}function le(e){var t;return(t=class extends e{constructor(e,t,...n){super(...n),this.memory=t,this.onMount=e||null,this.onUnmount=null,this.depth=1}setDepth(e){this.depth=null==e?1:'string'==typeof e?n[e]:e}reset(e,t,n=!1){return this.use(t,n,e)}use(e,t=!1,n){const o=this.memory;if(this.depth<-1){if(-2!==this.depth)return!1}else if(!t&&s.areEqual(o,e,this.depth))return!1;return void 0!==n&&(this.onUnmount&&this.onUnmount(o,e,!1),this.onUnmount=null,this.onMount=n),this.memory=e,this.onMount&&(this.onUnmount=this.onMount(e,o)||null),!1}cancel(e=!0,t=!1,n=!1){const s=t?void 0:this.memory;e&&this.onUnmount&&this.onUnmount(this.memory,s,!0),this.memory=s,n&&(this.onMount=null,this.onUnmount=null)}}).MIX_DOM_CLASS='Effect',t}class de extends(le(Object)){}const ce=le,ue=(e,t,o=1)=>{let r,i=[];const a='string'==typeof o?n[o]:o;return(...n)=>{const o=e(...n);if(a<-1){if(-2!==a)return r}else if(s.areEqual(o,i,a))return r;return i=o,r=t(...i),r}},he=a.newContentPassDef(),fe=a.newContentPassDef({},!0),pe={def:i,defHTML:(e,t,n,o)=>{const r={MIX_DOM_DEF:'content',tag:t||'',childDefs:[],domContent:e,domHTMLMode:!0};return t&&n&&(r.props=s.cleanDOMProps(n)),null!=o&&(r.key=o),r},Content:he,withContent:(...e)=>i(pe.Fragment,{withContent:!0},...e),ContentCopy:fe,copyContent:a.newContentCopyDef,ContextAttach:t,CompareDepthByMode:n,SignalMan:D,SignalManMixin:g,DataMan:A,DataManMixin:R,DataSignalMan:j,DataSignalManMixin:k,Component:Z,ComponentMixin:Q,Host:oe,Context:W,Ref:C,Effect:de,EffectMixin:ce,Contexts:S,Fragment:O,Portal:_,Element:x,Empty:N,EmptyStream:P,newHost:(e,t,n,s)=>new oe(e,t,n,s),newContext:H,newContexts:K,newRef:()=>new C,newEffect:(e,t)=>new de(e,t),component:$,componentWith:J,shadow:function(e,t,n=e.name){const s=e.MIX_DOM_CLASS?{[n]:class extends e{}}[n]:$(e,n);if(s.api=new q,t)for(const e in t)s.api.listenTo(e,t[e]);return s},shadowWith:(e,t,n=e.name)=>{const s=J(e,n);if(s.api=new q,t)for(const e in t)s.api.listenTo(e,t[e]);return s},spread:e=>e.length>1?function(t){return e.call(this,t)}:e,stream:()=>{var e;return(e=class e extends Z{canRefresh(){return e.source===this}preRefresh(t,n){return e.source===this&&e.closure.preRefresh(t,this,n)||null}applyRefresh(t=!1){return e.source===this&&e.closure.applyRefresh(t)||[[],[]]}reattachSource(t=!1){return e.reattachSourceBy(this,t)}refreshSource(t){e.refreshStream(t)}render(){return null}static isStream(){return!0}static addSource(t){e.sources.add(t)}static removeSource(t,n=!0){if(e.sources.delete(t),e.source!==t)return null;let s=null,o=e.closure.collectInterested(t);return s=e.closure.applyEnvelope(null),e.source=null,e.closure.sourceBoundary=null,(n||o)&&t.boundary.host.listenTo('onRender',(()=>{if(o){const e=new Map([[t,[]]]);for(const t of o)t.host.services.absorbUpdates(t,{streamed:e})}n&&e.refreshStream()}),null,d.OneShot),s}static getBestStream(){const t=e.sources,n=t.size;if(n<2)return n&&[...t][0]||null;let s=-1/0,o=null;for(const e of t){const t=e.props.importance||0;t>s&&(o=e,s=t)}return o}static reattachSourceBy(t,n=!1){const s=e.source;if(s===t||s&&!n)return null;if(s!==t&&s&&(t.props.importance||0)<=(s.props.importance||0))return null;let o=null;const r=t.boundary;return s&&(o=e.closure.applyEnvelope(null),o&&r.host!==s.boundary.host&&(s.boundary.host.services.absorbChanges(o[0],o[1],null),o=null)),e.source=t,e.closure.sourceBoundary=r,r.closure.envelope&&(o=I.mergeChanges(o,e.closure.applyEnvelope(r.closure.envelope))),o}static refreshStream(t){const n=e.getBestStream(),s=e.source||null;if(n===s)return;const o=e.closure,r=n?(s=!0)=>{if(s&&e.source!==n)return;const r=n.boundary;e.source=n,o.sourceBoundary=r;const i=o.applyEnvelope(r.closure.envelope);(i[0][0]||i[1][0])&&r.host.services.absorbChanges(i[0],i[1],s?null:t)}:null;if(s){const i=s.boundary.host;let a=o.applyEnvelope(null);e.source=n,o.sourceBoundary=n&&n.boundary,a[0][0]||a[1][0]?(r&&i.listenTo('onUpdate',r,null,d.OneShot),i.services.absorbChanges(a[0],a[1],t)):r&&r()}else r&&r(!1)}}).MIX_DOM_CLASS='Stream',e.closure=new E,e.source=null,e.sources=new Set,e.contentLinks=new Set,e.Content=Object.assign(Object.assign({},a.newContentPassDef(e)),{contentPass:null,getContentStream:()=>e}),e.ContentCopy=Object.assign(Object.assign({},a.newContentPassDef(e,!0)),{contentPass:null,getContentStream:()=>e}),e.copyContent=t=>Object.assign(Object.assign({},a.newContentPassDef(null!=t?t:e,!0)),{contentPass:null,getContentStream:()=>e}),e.withContent=(...t)=>a.newDef(O,{withContent:()=>e,_key:e},...t),e},wrapper:Y,mixin:function(e){return e},mixFuncs:re,mixFuncsWith:function(...e){const t=e.length;return'function'!=typeof e[t-1]?re(...e.slice(0,t-1),!0):re(...e,!0)},mixClassFuncs:ae,mixClassFuncsWith:function(...e){const t=e.length;return ae(...'function'!=typeof e[t-1]?e.slice(0,t-1):e)},mixClassMixins:function(...e){return ie(...e)},mixMixins:ie,mixMixinsWith:function(...e){const t=e.length;return'function'!=typeof e[t-1]?ie(...e.slice(0,t-1)):ie(e)},mixHOCs:function(e,...t){let n=e;for(const e of t)n=e(n);return e=>a.newDef(n,e,he)},dataPicker:ue,dataSelector:(e,t,n=1)=>ue(((...t)=>e.map((e=>e&&e(...t)))),t,n),findTreeNodesIn:(e,t,n,o,r,i)=>l.treeNodesWithin(e,t&&s.buildRecordable(t),n,o,r,i),findComponentsIn:(e,t,n,s,o)=>l.treeNodesWithin(e,{boundary:!0},t,n,s,o).map((e=>e.boundary&&e.boundary.component)),findElementsIn:(e,t,n,s,o)=>l.treeNodesWithin(e,{dom:!0},t,n,s,o).map((e=>e.domNode)),queryElementIn:(e,t,n,s)=>l.domElementByQuery(e,t,n,s),queryElementsIn:(e,t,n,s,o)=>l.domElementsByQuery(e,t,n,s,o),readAsString:e=>{const t=e&&(e.constructor.MIX_DOM_CLASS?e.boundary.treeNode:e.treeNode||'string'==typeof e.type&&e);return t?M.readAsString(t):''},classNames:s.cleanDOMClass,parseStyle:s.cleanDOMStyle,areEqual:s.areEqual,deepCopy:s.deepCopy,range:s.range};module.exports=pe;
